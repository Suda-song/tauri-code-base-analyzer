# ğŸ”„ æŒä¹…åŒ–å¤šè½®å¯¹è¯ - ä»£ç å˜æ›´æ€»ç»“

## âœ¨ æ–°å¢æ–‡ä»¶

### 1. TypeScript Bridgeï¼ˆæŒä¹…åŒ–ç‰ˆæœ¬ï¼‰

**æ–‡ä»¶**: `scripts/mcp-agent-bridge-persistent.ts`

**åŠŸèƒ½**:

- ğŸ”„ **å¸¸é©»è¿›ç¨‹** - å¯åŠ¨åæŒç»­è¿è¡Œï¼Œä¸ä¼šæ¯æ¬¡éƒ½é‡å¯
- ğŸ’¾ **Session ç®¡ç†** - ä¿å­˜å¹¶ç»´æŠ¤ `session_id`
- ğŸ” **è‡ªåŠ¨æ¢å¤** - ä½¿ç”¨ SDK çš„ `resume` é€‰é¡¹æ¢å¤ä¼šè¯
- ğŸ“ **å‘½ä»¤æ”¯æŒ**:
  - `query` - å‘é€æŸ¥è¯¢ï¼ˆè‡ªåŠ¨åœ¨åŒä¸€ä¼šè¯ä¸­ï¼‰
  - `reset` - é‡ç½®ä¼šè¯
  - `info` - æŸ¥çœ‹ä¼šè¯ä¿¡æ¯

**å…³é”®ä»£ç **:

```typescript
class PersistentMcpAgentBridge {
  private currentSessionId: string | undefined;

  async executeQuery(request: BridgeRequest) {
    const options: Options = {
      resume: request.session_id || this.currentSessionId, // ğŸ‘ˆ å…³é”®
    };
    // SDK ä¼šè‡ªåŠ¨åŠ è½½å†å²å¯¹è¯
  }
}
```

---

### 2. Rust æµ‹è¯•ç¨‹åºï¼ˆæŒä¹…åŒ–ç‰ˆæœ¬ï¼‰

**æ–‡ä»¶**: `src-tauri/examples/persistent_chat_test.rs`

**åŠŸèƒ½**:

- ğŸš€ **å¯åŠ¨å¸¸é©» Bridge** - åªå¯åŠ¨ä¸€æ¬¡ Node.js è¿›ç¨‹
- ğŸ’¬ **å¤šæ¬¡æŸ¥è¯¢** - å¤ç”¨åŒä¸€ä¸ªè¿›ç¨‹
- ğŸ†” **ç»´æŠ¤ session_id** - æ¯æ¬¡æŸ¥è¯¢éƒ½ä¼ é€’
- ğŸ“Š **äº¤äº’å¼å‘½ä»¤**:
  - æ™®é€šè¾“å…¥ - å‘é€æ¶ˆæ¯
  - `info` - æŸ¥çœ‹ä¼šè¯ä¿¡æ¯
  - `reset` - é‡ç½®ä¼šè¯
  - `exit` - é€€å‡º

**å…³é”®ä»£ç **:

```rust
struct PersistentAgentBridge {
    child: Child,                    // å¸¸é©»çš„ Node.js è¿›ç¨‹
    session_id: Option<String>,      // å½“å‰ session_id
}

fn send_message(&mut self, prompt: &str, workspace: &str) {
    // å‘é€åˆ°å·²å¯åŠ¨çš„ Bridgeï¼ˆä¸ä¼šé‡å¯è¿›ç¨‹ï¼‰
    // ä¼ é€’ session_id ä»¥æ¢å¤ä¼šè¯
}
```

---

### 3. æµ‹è¯•è„šæœ¬

**æ–‡ä»¶**: `scripts/test-persistent-chat.sh`

**åŠŸèƒ½**:

- ğŸ“¦ **è‡ªåŠ¨ç¼–è¯‘** - æ£€æŸ¥å¹¶ç¼–è¯‘æ‰€éœ€ç»„ä»¶
- ğŸš€ **ä¸€é”®å¯åŠ¨** - è‡ªåŠ¨è¿è¡ŒæŒä¹…åŒ–å¯¹è¯æµ‹è¯•
- ğŸ“ **ä½¿ç”¨è¯´æ˜** - æ˜¾ç¤ºè¯¦ç»†çš„ä½¿ç”¨æç¤º

**ä½¿ç”¨æ–¹æ³•**:

```bash
./scripts/test-persistent-chat.sh
```

---

### 4. æ–‡æ¡£

**æ–‡ä»¶**: `PERSISTENT_CHAT_GUIDE.md`

**å†…å®¹**:

- ğŸ“– ä¸¤ç§æ¨¡å¼å¯¹æ¯”ï¼ˆç‹¬ç«‹ vs æŒä¹…åŒ–ï¼‰
- ğŸ”„ å·¥ä½œæµç¨‹è¯¦è§£
- ğŸš€ å¿«é€Ÿå¼€å§‹æŒ‡å—
- ğŸ’¬ ä½¿ç”¨ç¤ºä¾‹
- ğŸ› æ•…éšœæ’æŸ¥
- ğŸ¯ æœ€ä½³å®è·µ

---

## ğŸ”§ ä¿®æ”¹æ–‡ä»¶

### 1. `scripts/package.json`

**å˜æ›´**:

```json
{
  "scripts": {
    "build:mcp-persistent": "tsc mcp-agent-bridge-persistent.ts ...", // æ–°å¢
    "build:all": "npm run build:mcp && npm run build:mcp-persistent" // æ›´æ–°
  }
}
```

---

## ğŸ“Š å¯¹æ¯”ï¼šæ—§å®ç° vs æ–°å®ç°

| æ–¹é¢             | æ—§å®ç°ï¼ˆç‹¬ç«‹æ¨¡å¼ï¼‰                            | æ–°å®ç°ï¼ˆæŒä¹…åŒ–æ¨¡å¼ï¼‰                                         |
| ---------------- | --------------------------------------------- | ------------------------------------------------------------ |
| **æ–‡ä»¶**         | `simple_chat_test.rs` + `mcp-agent-bridge.ts` | `persistent_chat_test.rs` + `mcp-agent-bridge-persistent.ts` |
| **è¿›ç¨‹ç®¡ç†**     | æ¯æ¬¡å¯åŠ¨æ–°è¿›ç¨‹                                | å¸¸é©»è¿›ç¨‹                                                     |
| **Session**      | æ¯æ¬¡éƒ½æ˜¯æ–°çš„                                  | åŒä¸€ä¸ª Session                                               |
| **AI è®°å¿†**      | âŒ ä¸è®°å¾—ä¹‹å‰çš„å¯¹è¯                           | âœ… è®°ä½æ‰€æœ‰å†å²                                              |
| **å·¥å…·è°ƒç”¨å†å²** | âŒ ä¸ä¿ç•™                                     | âœ… å®Œæ•´ä¿ç•™                                                  |
| **å“åº”é€Ÿåº¦**     | æ…¢ï¼ˆæ¯æ¬¡å¯åŠ¨è¿›ç¨‹ï¼‰                            | å¿«ï¼ˆè¿›ç¨‹å¤ç”¨ï¼‰                                               |
| **é€‚ç”¨åœºæ™¯**     | å•æ¬¡ä»»åŠ¡                                      | å¤šè½®å¯¹è¯ã€å¤æ‚ä»»åŠ¡                                           |

---

## ğŸ”„ å·¥ä½œæµç¨‹å˜åŒ–

### æ—§å®ç°ï¼ˆæ¯æ¬¡æ–° Sessionï¼‰

```
ç¬¬ 1 è½®: å¯åŠ¨è¿›ç¨‹ â†’ åˆ›å»º Session-1 â†’ AI å›å¤ â†’ è¿›ç¨‹ç»“æŸ
ç¬¬ 2 è½®: å¯åŠ¨è¿›ç¨‹ â†’ åˆ›å»º Session-2 â†’ AI å›å¤ â†’ è¿›ç¨‹ç»“æŸï¼ˆä¸è®°å¾—ç¬¬ 1 è½®ï¼‰
ç¬¬ 3 è½®: å¯åŠ¨è¿›ç¨‹ â†’ åˆ›å»º Session-3 â†’ AI å›å¤ â†’ è¿›ç¨‹ç»“æŸï¼ˆä¸è®°å¾—å‰é¢ï¼‰
```

### æ–°å®ç°ï¼ˆåŒä¸€ Sessionï¼‰

```
å¯åŠ¨: è¿›ç¨‹å¯åŠ¨ â†’ ç­‰å¾…å‘½ä»¤

ç¬¬ 1 è½®: æŸ¥è¯¢ â†’ åˆ›å»º Session-ABC â†’ AI å›å¤ â†’ ä¿å­˜ Session-ABC
ç¬¬ 2 è½®: æŸ¥è¯¢ â†’ æ¢å¤ Session-ABC â†’ AI å›å¤ï¼ˆè®°å¾—ç¬¬ 1 è½®ï¼‰â†’ ä¿å­˜
ç¬¬ 3 è½®: æŸ¥è¯¢ â†’ æ¢å¤ Session-ABC â†’ AI å›å¤ï¼ˆè®°å¾—æ‰€æœ‰å†å²ï¼‰â†’ ä¿å­˜

é€€å‡º: è¿›ç¨‹ç»“æŸ
```

---

## ğŸš€ å¿«é€Ÿæµ‹è¯•

### æ–¹å¼ 1: ä½¿ç”¨æµ‹è¯•è„šæœ¬ï¼ˆæ¨èï¼‰

```bash
# ä¸€é”®å¯åŠ¨
./scripts/test-persistent-chat.sh
```

### æ–¹å¼ 2: æ‰‹åŠ¨ç¼–è¯‘å’Œè¿è¡Œ

```bash
# 1. ç¼–è¯‘ Bridge
cd scripts
pnpm run build:mcp-persistent

# 2. è¿è¡Œæµ‹è¯•
cd ../src-tauri
cargo run --example persistent_chat_test
```

---

## ğŸ’¬ æµ‹è¯•ç¤ºä¾‹

è¯•è¯•è¿™ä¸ªå¯¹è¯æµç¨‹æ¥éªŒè¯ AI çš„è®°å¿†èƒ½åŠ›ï¼š

```
ä½  > ä½ å¥½ï¼Œæˆ‘å«å°æ˜ï¼Œæˆ‘æ˜¯ä¸€ä¸ªå‰ç«¯å·¥ç¨‹å¸ˆ

ğŸ¤– AI > ä½ å¥½å°æ˜ï¼å¾ˆé«˜å…´è®¤è¯†ä½ ã€‚ä½œä¸ºå‰ç«¯å·¥ç¨‹å¸ˆï¼Œä½ æœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®åŠ©çš„å—ï¼Ÿ

ä½  > æˆ‘åˆšæ‰è¯´æˆ‘å«ä»€ä¹ˆåå­—ï¼Ÿ

ğŸ¤– AI > ä½ åˆšæ‰è¯´ä½ å«å°æ˜ã€‚âœ… è®°ä½äº†ï¼

ä½  > æˆ‘æ˜¯åšä»€ä¹ˆå·¥ä½œçš„ï¼Ÿ

ğŸ¤– AI > ä½ æ˜¯ä¸€ä¸ªå‰ç«¯å·¥ç¨‹å¸ˆã€‚âœ… è¿˜è®°å¾—ï¼

ä½  > info

ğŸ“Š ä¼šè¯ä¿¡æ¯:
   å·¥ä½œç›®å½•: /tmp/test-workspace
   å·²å¯¹è¯è½®æ•°: 3
   Session ID: f8a3c2d1...  ğŸ‘ˆ å§‹ç»ˆæ˜¯åŒä¸€ä¸ªï¼
   çŠ¶æ€: æ´»è·ƒï¼ˆAI è®°ä½æ‰€æœ‰å†å²å¯¹è¯ï¼‰
```

---

## ğŸ”‘ æ ¸å¿ƒæŠ€æœ¯ç‚¹

### 1. SDK çš„ `resume` é€‰é¡¹

```typescript
const response = query({
  prompt: "æ–°æ¶ˆæ¯",
  options: {
    resume: "session-id-from-previous", // ğŸ‘ˆ ä¼ é€’ session_id
    // SDK ä¼šï¼š
    // 1. æŸ¥æ‰¾è¿™ä¸ª Session çš„ transcript æ–‡ä»¶
    // 2. åŠ è½½å®Œæ•´çš„å¯¹è¯å†å²
    // 3. å°†æ–°æ¶ˆæ¯è¿½åŠ åˆ°å†å²åé¢
    // 4. å‘é€å®Œæ•´å†å²ç»™ Claude API
  },
});
```

### 2. Session ID çš„æ•è·å’Œä¼ é€’

```typescript
// TypeScript Bridge ä¸­
for await (const message of response) {
  if (message.type === "system" && message.subtype === "init") {
    sessionId = message.session_id; // ğŸ‘ˆ æ•è·
    this.currentSessionId = sessionId; // ğŸ‘ˆ ä¿å­˜
  }
}
```

```rust
// Rust ä¸­
if let Some(sid) = response["session_id"].as_str() {
    self.session_id = Some(sid.to_string());  // ğŸ‘ˆ ä¿å­˜
}

// ä¸‹æ¬¡æŸ¥è¯¢æ—¶
let request = serde_json::json!({
    "session_id": self.session_id,  // ğŸ‘ˆ ä¼ é€’
    // ...
});
```

### 3. è¿›ç¨‹ç®¡ç†

```rust
// å¯åŠ¨ä¸€æ¬¡
let mut bridge = PersistentAgentBridge::new()?;

// å¤šæ¬¡æŸ¥è¯¢ï¼ˆå¤ç”¨åŒä¸€è¿›ç¨‹ï¼‰
loop {
    let response = bridge.send_message(user_input, workspace)?;
    // Bridge è¿›ç¨‹æŒç»­è¿è¡Œ
}

// é€€å‡ºæ—¶è‡ªåŠ¨æ¸…ç†
// Drop trait ä¼šè‡ªåŠ¨ kill è¿›ç¨‹
```

---

## ğŸ“‚ æ–‡ä»¶ç»“æ„

```
tauri-code-base-analyzer/
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ mcp-agent-bridge.ts              # æ—§ç‰ˆï¼ˆç‹¬ç«‹æ¨¡å¼ï¼‰
â”‚   â”œâ”€â”€ mcp-agent-bridge-persistent.ts   # æ–°ç‰ˆï¼ˆæŒä¹…åŒ–æ¨¡å¼ï¼‰âœ¨
â”‚   â”œâ”€â”€ test-persistent-chat.sh          # æµ‹è¯•è„šæœ¬ âœ¨
â”‚   â”œâ”€â”€ package.json                     # æ›´æ–°
â”‚   â””â”€â”€ dist/
â”‚       â””â”€â”€ mcp-agent-bridge-persistent.js  # ç¼–è¯‘å âœ¨
â”‚
â”œâ”€â”€ src-tauri/
â”‚   â””â”€â”€ examples/
â”‚       â”œâ”€â”€ simple_chat_test.rs          # æ—§ç‰ˆï¼ˆç‹¬ç«‹æ¨¡å¼ï¼‰
â”‚       â””â”€â”€ persistent_chat_test.rs      # æ–°ç‰ˆï¼ˆæŒä¹…åŒ–æ¨¡å¼ï¼‰âœ¨
â”‚
â””â”€â”€ docs/
    â”œâ”€â”€ PERSISTENT_CHAT_GUIDE.md         # ä½¿ç”¨æŒ‡å— âœ¨
    â””â”€â”€ PERSISTENT_CHAT_CHANGES.md       # æœ¬æ–‡æ¡£ âœ¨
```

---

## âœ… éªŒè¯æ¸…å•

å®Œæˆä»¥ä¸‹æ­¥éª¤æ¥éªŒè¯å®ç°ï¼š

- [ ] ç¼–è¯‘æŒä¹…åŒ– Bridgeï¼š`cd scripts && pnpm run build:mcp-persistent`
- [ ] ç¼–è¯‘ MCP æœåŠ¡å™¨ï¼š`cd src-tauri && cargo build --release --bin codebase-mcp-server`
- [ ] è¿è¡Œæµ‹è¯•ï¼š`./scripts/test-persistent-chat.sh`
- [ ] æµ‹è¯• AI è®°å¿†ï¼š
  - [ ] å‘Šè¯‰ AI ä½ çš„åå­—
  - [ ] é—® AI ä½ å«ä»€ä¹ˆåå­—
  - [ ] éªŒè¯ AI æ˜¯å¦è®°ä½
- [ ] æµ‹è¯•ä¼šè¯ä¿¡æ¯ï¼šè¾“å…¥ `info` æŸ¥çœ‹ Session ID
- [ ] æµ‹è¯•ä¼šè¯é‡ç½®ï¼šè¾“å…¥ `reset` åéªŒè¯ AI ä¸è®°å¾—ä¹‹å‰çš„å†…å®¹
- [ ] æµ‹è¯•å·¥å…·è°ƒç”¨ï¼šè®© AI åˆ†æä¸€ä¸ªé¡¹ç›®ï¼ŒéªŒè¯å·¥å…·è°ƒç”¨å†å²

---

## ğŸ¯ æ€»ç»“

é€šè¿‡è¿™æ¬¡æ”¹é€ ï¼Œæˆ‘ä»¬å®ç°äº†ï¼š

âœ… **çœŸæ­£çš„å¤šè½®å¯¹è¯** - æ‰€æœ‰å¯¹è¯åœ¨åŒä¸€ä¸ª Session  
âœ… **å®Œæ•´çš„ AI è®°å¿†** - AI è®°ä½æ‰€æœ‰å†å²å¯¹è¯  
âœ… **å·¥å…·è°ƒç”¨å†å²** - ä¿ç•™å®Œæ•´çš„å·¥å…·ä½¿ç”¨è®°å½•  
âœ… **æ›´å¥½çš„æ€§èƒ½** - è¿›ç¨‹å¤ç”¨ï¼Œå“åº”æ›´å¿«  
âœ… **çµæ´»çš„æ§åˆ¶** - æ”¯æŒä¼šè¯é‡ç½®å’Œä¿¡æ¯æŸ¥çœ‹

**æ ¸å¿ƒåŸç†**ï¼šåˆ©ç”¨ SDK çš„ `resume` åŠŸèƒ½ï¼ŒSDK ä¼šè‡ªåŠ¨ç®¡ç†å¯¹è¯å†å²ï¼

ğŸš€ **å¼€å§‹ä½¿ç”¨æŒä¹…åŒ–å¤šè½®å¯¹è¯å§ï¼**
