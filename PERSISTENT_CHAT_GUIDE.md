# ğŸ”„ æŒä¹…åŒ–å¤šè½®å¯¹è¯å®ç°æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æˆ‘ä»¬å®ç°äº†ä¸¤ç§å¤šè½®å¯¹è¯æ¨¡å¼ï¼š

| æ¨¡å¼           | æ–‡ä»¶                                                         | Session ç®¡ç†      | å¯¹è¯å†å²    | é€‚ç”¨åœºæ™¯ |
| -------------- | ------------------------------------------------------------ | ----------------- | ----------- | -------- |
| **ç‹¬ç«‹æ¨¡å¼**   | `simple_chat_test.rs` + `mcp-agent-bridge.ts`                | âŒ æ¯æ¬¡éƒ½æ˜¯æ–°çš„   | âŒ ä¸è®°å¾—   | å•æ¬¡ä»»åŠ¡ |
| **æŒä¹…åŒ–æ¨¡å¼** | `persistent_chat_test.rs` + `mcp-agent-bridge-persistent.ts` | âœ… åŒä¸€ä¸ª Session | âœ… å®Œæ•´è®°å¿† | å¤šè½®å¯¹è¯ |

---

## ğŸ†• æ–°å¢æ–‡ä»¶

### 1. `scripts/mcp-agent-bridge-persistent.ts`

**æ ¸å¿ƒç‰¹æ€§ï¼š**

- ğŸ”„ **å¸¸é©»è¿›ç¨‹** - ä¸ä¼šæ¯æ¬¡éƒ½é‡å¯
- ğŸ’¾ **ä¿å­˜ session_id** - ç»´æŠ¤å½“å‰ä¼šè¯çŠ¶æ€
- ğŸ” **ä½¿ç”¨ SDK resume** - è‡ªåŠ¨æ¢å¤å¯¹è¯å†å²
- ğŸ“ **ä¸‰ç§å‘½ä»¤æ”¯æŒ**ï¼š
  - `query` - å‘é€æŸ¥è¯¢ï¼ˆè‡ªåŠ¨åœ¨åŒä¸€ä¼šè¯ä¸­ï¼‰
  - `reset` - é‡ç½®ä¼šè¯
  - `info` - æŸ¥çœ‹ä¼šè¯ä¿¡æ¯

**å…³é”®å®ç°ï¼š**

```typescript
class PersistentMcpAgentBridge {
  private currentSessionId: string | undefined; // ä¿å­˜å½“å‰ session_id

  async executeQuery(request: BridgeRequest) {
    const options: Options = {
      // ...
      resume: request.session_id || this.currentSessionId, // ğŸ‘ˆ ä¼ é€’ session_id
    };

    for await (const message of response) {
      if (message.type === "system" && message.subtype === "init") {
        this.currentSessionId = message.session_id; // ğŸ‘ˆ ä¿å­˜è¿”å›çš„ session_id
      }
    }
  }
}
```

### 2. `src-tauri/examples/persistent_chat_test.rs`

**æ ¸å¿ƒç‰¹æ€§ï¼š**

- ğŸš€ **å¯åŠ¨å¸¸é©» Bridge** - åªå¯åŠ¨ä¸€æ¬¡
- ğŸ’¬ **å¤šæ¬¡æŸ¥è¯¢** - å¤ç”¨åŒä¸€ä¸ªè¿›ç¨‹
- ğŸ†” **ç»´æŠ¤ session_id** - æ¯æ¬¡æŸ¥è¯¢éƒ½ä¼ é€’
- ğŸ“Š **ä¼šè¯ä¿¡æ¯æŸ¥çœ‹** - éšæ—¶æŸ¥çœ‹ Session çŠ¶æ€

**å…³é”®å®ç°ï¼š**

```rust
struct PersistentAgentBridge {
    child: Child,                    // Node.js å­è¿›ç¨‹
    session_id: Option<String>,      // å½“å‰ session_id
}

impl PersistentAgentBridge {
    fn send_message(&mut self, prompt: &str, workspace: &str) -> Result<...> {
        let request = serde_json::json!({
            "command": "query",
            "session_id": self.session_id,  // ğŸ‘ˆ ä¼ é€’ session_id
            // ...
        });

        // å‘é€åˆ° Bridgeï¼ˆå¤ç”¨åŒä¸€ä¸ªè¿›ç¨‹ï¼‰
        writeln!(stdin, "{}", serde_json::to_string(&request)?)?;

        // æ›´æ–° session_id
        if let Some(sid) = response["session_id"].as_str() {
            self.session_id = Some(sid.to_string());  // ğŸ‘ˆ ä¿å­˜è¿”å›çš„ session_id
        }
    }
}
```

### 3. `scripts/test-persistent-chat.sh`

ä¸€é”®å¯åŠ¨è„šæœ¬ï¼Œè‡ªåŠ¨å®Œæˆï¼š

1. ç¼–è¯‘æŒä¹…åŒ– Bridge
2. ç¼–è¯‘ MCP æœåŠ¡å™¨
3. è¿è¡Œæµ‹è¯•

---

## ğŸ”„ å·¥ä½œæµç¨‹å¯¹æ¯”

### âŒ æ—§å®ç°ï¼ˆç‹¬ç«‹æ¨¡å¼ï¼‰

```
ç¬¬ 1 è½®å¯¹è¯ï¼š
ä½  > ä½ å¥½ï¼Œæˆ‘å«å°æ˜
    â†“
å¯åŠ¨æ–°çš„ Node.js è¿›ç¨‹ â†’ åˆ›å»ºæ–° Session (sid-1)
    â†“
AI > ä½ å¥½å°æ˜ï¼
    â†“
è¿›ç¨‹ç»“æŸï¼ŒSession ä¸¢å¤±

ç¬¬ 2 è½®å¯¹è¯ï¼š
ä½  > æˆ‘å«ä»€ä¹ˆåå­—ï¼Ÿ
    â†“
å¯åŠ¨æ–°çš„ Node.js è¿›ç¨‹ â†’ åˆ›å»ºæ–° Session (sid-2)  âš ï¸ åˆæ˜¯æ–°çš„ï¼
    â†“
AI > æˆ‘ä¸çŸ¥é“ä½ å«ä»€ä¹ˆåå­—ã€‚âŒ ä¸è®°å¾—äº†ï¼
    â†“
è¿›ç¨‹ç»“æŸ
```

**é—®é¢˜ï¼š**

- âŒ æ¯æ¬¡éƒ½å¯åŠ¨æ–°è¿›ç¨‹
- âŒ æ¯æ¬¡éƒ½æ˜¯æ–° Session
- âŒ AI ä¸è®°å¾—ä¹‹å‰çš„å¯¹è¯

---

### âœ… æ–°å®ç°ï¼ˆæŒä¹…åŒ–æ¨¡å¼ï¼‰

```
å¯åŠ¨ï¼š
Node.js Bridge å¯åŠ¨ï¼ˆå¸¸é©»ï¼‰â†’ ç­‰å¾…å‘½ä»¤

ç¬¬ 1 è½®å¯¹è¯ï¼š
ä½  > ä½ å¥½ï¼Œæˆ‘å«å°æ˜
    â†“
å‘é€ query å‘½ä»¤ï¼ˆsession_id: Noneï¼‰
    â†“
SDK åˆ›å»º Session (sid-abc123)
    â†“
AI > ä½ å¥½å°æ˜ï¼
    â†“
ä¿å­˜ session_id: "sid-abc123"
    â†“
è¿›ç¨‹ç»§ç»­è¿è¡Œ âœ…

ç¬¬ 2 è½®å¯¹è¯ï¼š
ä½  > æˆ‘å«ä»€ä¹ˆåå­—ï¼Ÿ
    â†“
å‘é€ query å‘½ä»¤ï¼ˆsession_id: "sid-abc123"ï¼‰ğŸ‘ˆ ä¼ é€’ä¹‹å‰çš„ session_id
    â†“
SDK åŠ è½½ Session "sid-abc123" çš„å†å²ï¼š
  - User: "ä½ å¥½ï¼Œæˆ‘å«å°æ˜"
  - Assistant: "ä½ å¥½å°æ˜ï¼"
  - User: "æˆ‘å«ä»€ä¹ˆåå­—ï¼Ÿ"
    â†“
AI > ä½ å«å°æ˜ã€‚âœ… è®°ä½äº†ï¼
    â†“
è¿›ç¨‹ç»§ç»­è¿è¡Œ âœ…

ç¬¬ 3 è½®å¯¹è¯ï¼š
ä½  > å¸®æˆ‘åˆ†æ /path/to/project
    â†“
å‘é€ query å‘½ä»¤ï¼ˆsession_id: "sid-abc123"ï¼‰ğŸ‘ˆ è¿˜æ˜¯åŒä¸€ä¸ª
    â†“
SDK åŠ è½½å®Œæ•´å†å²ï¼ˆåŒ…æ‹¬ä¹‹å‰çš„æ‰€æœ‰å¯¹è¯ï¼‰
    â†“
AI > å¥½çš„å°æ˜ï¼Œæˆ‘æ¥å¸®ä½ åˆ†æ...âœ… è¿˜è®°å¾—ä½ å«å°æ˜ï¼
    [è°ƒç”¨ @codebase/scan å·¥å…·]
    [è°ƒç”¨ @codebase/analyze å·¥å…·]
    â†“
è¿›ç¨‹ç»§ç»­è¿è¡Œ âœ…

é€€å‡ºï¼š
è¿›ç¨‹æ­£å¸¸å…³é—­
```

**ä¼˜åŠ¿ï¼š**

- âœ… ä¸€ä¸ªè¿›ç¨‹ï¼Œå¤šæ¬¡æŸ¥è¯¢
- âœ… åŒä¸€ä¸ª Session
- âœ… AI è®°ä½æ‰€æœ‰å†å²
- âœ… æ”¯æŒå·¥å…·è°ƒç”¨å†å²

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æ–¹å¼ 1: ä½¿ç”¨æµ‹è¯•è„šæœ¬ï¼ˆæ¨èï¼‰

```bash
# ä¸€é”®å¯åŠ¨
./scripts/test-persistent-chat.sh
```

### æ–¹å¼ 2: æ‰‹åŠ¨æ­¥éª¤

```bash
# 1. ç¼–è¯‘æŒä¹…åŒ– Bridge
cd scripts
pnpm run build:mcp-persistent
cd ..

# 2. ç¼–è¯‘ MCP æœåŠ¡å™¨ï¼ˆå¦‚æœéœ€è¦ï¼‰
cd src-tauri
cargo build --release --bin codebase-mcp-server
cd ..

# 3. è¿è¡Œæµ‹è¯•
cd src-tauri
cargo run --example persistent_chat_test
```

---

## ğŸ’¬ ä½¿ç”¨ç¤ºä¾‹

### æµ‹è¯• AI è®°å¿†

```
ä½  > ä½ å¥½ï¼Œæˆ‘å«å°æ˜ï¼Œæˆ‘æ˜¯ä¸€ä¸ªå‰ç«¯å·¥ç¨‹å¸ˆ

ğŸ¤– AI > ä½ å¥½å°æ˜ï¼å¾ˆé«˜å…´è®¤è¯†ä½ ã€‚ä½œä¸ºå‰ç«¯å·¥ç¨‹å¸ˆï¼Œä½ æœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®åŠ©çš„å—ï¼Ÿ

ä½  > æˆ‘åˆšæ‰è¯´æˆ‘å«ä»€ä¹ˆåå­—ï¼Ÿ

ğŸ¤– AI > ä½ åˆšæ‰è¯´ä½ å«å°æ˜ã€‚

ä½  > æˆ‘æ˜¯åšä»€ä¹ˆå·¥ä½œçš„ï¼Ÿ

ğŸ¤– AI > ä½ æ˜¯ä¸€ä¸ªå‰ç«¯å·¥ç¨‹å¸ˆã€‚

ä½  > info

ğŸ“Š ä¼šè¯ä¿¡æ¯:
   å·¥ä½œç›®å½•: /tmp/test-workspace
   å·²å¯¹è¯è½®æ•°: 3
   Session ID: f8a3c2d1...
   çŠ¶æ€: æ´»è·ƒï¼ˆAI è®°ä½æ‰€æœ‰å†å²å¯¹è¯ï¼‰
```

### ä½¿ç”¨å·¥å…·

```
ä½  > å¸®æˆ‘åˆ†æä¸€ä¸‹ /Users/xxx/my-project è¿™ä¸ªé¡¹ç›®

ğŸ¤– AI > å¥½çš„å°æ˜ï¼Œè®©æˆ‘æ¥åˆ†æè¿™ä¸ªé¡¹ç›®...
     [è°ƒç”¨ @codebase/scan å·¥å…·]
     æ­£åœ¨æ‰«æé¡¹ç›®...
     [è°ƒç”¨ @codebase/analyze å·¥å…·]
     åˆ†æå®Œæˆï¼

     è¿™ä¸ªé¡¹ç›®åŒ…å«ï¼š
     - 50 ä¸ª Vue ç»„ä»¶
     - 30 ä¸ª TypeScript æ–‡ä»¶
     - ...

     [Token: 1523, å·¥å…·è°ƒç”¨: 2æ¬¡, è½®æ•°: 4]
```

### é‡ç½®ä¼šè¯

```
ä½  > reset

ğŸ”„ ä¼šè¯å·²é‡ç½®ï¼Œä¸‹æ¬¡æŸ¥è¯¢å°†åˆ›å»ºæ–°ä¼šè¯

ä½  > æˆ‘å«ä»€ä¹ˆåå­—ï¼Ÿ

ğŸ¤– AI > æˆ‘ä¸çŸ¥é“ä½ å«ä»€ä¹ˆåå­—ï¼Œè¯·å‘Šè¯‰æˆ‘ã€‚
```

---

## ğŸ”§ é…ç½®è¯´æ˜

### API Key é…ç½®

æŒä¹…åŒ–æ¨¡å¼ä¼šè‡ªåŠ¨ä»ä»¥ä¸‹ä½ç½®è¯»å– API Keyï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰ï¼š

1. ç¯å¢ƒå˜é‡ `ANTHROPIC_API_KEY`
2. `.env` æ–‡ä»¶ï¼ˆ`src-tauri/.env` æˆ– `.env`ï¼‰
3. é»˜è®¤å€¼ï¼ˆrouter-config.json ä¸­çš„ keyï¼‰

### å·¥ä½œç›®å½•

é»˜è®¤å·¥ä½œç›®å½•ï¼š`/tmp/test-workspace`

å¯ä»¥åœ¨ä»£ç ä¸­ä¿®æ”¹ï¼š

```rust
let workspace = "/path/to/your/workspace";
```

---

## ğŸ“Š æŠ€æœ¯ç»†èŠ‚

### SDK çš„ resume æœºåˆ¶

```typescript
// ç¬¬ä¸€æ¬¡æŸ¥è¯¢ï¼ˆåˆ›å»ºæ–°ä¼šè¯ï¼‰
const response1 = query({
  prompt: "ä½ å¥½",
  options: {
    // resume æœªè®¾ç½®ï¼ŒSDK åˆ›å»ºæ–° Session
  },
});

// åç»­æŸ¥è¯¢ï¼ˆæ¢å¤ä¼šè¯ï¼‰
const response2 = query({
  prompt: "æˆ‘åˆšæ‰è¯´äº†ä»€ä¹ˆï¼Ÿ",
  options: {
    resume: "session-id-from-previous-call", // ğŸ‘ˆ ä¼ é€’ session_id
    // SDK ä¼šï¼š
    // 1. æŸ¥æ‰¾è¿™ä¸ª Session çš„ transcript æ–‡ä»¶
    // 2. åŠ è½½å®Œæ•´çš„å¯¹è¯å†å²
    // 3. å°†æ–°æ¶ˆæ¯è¿½åŠ åˆ°å†å²åé¢
    // 4. å‘é€å®Œæ•´å†å²ç»™ Claude API
  },
});
```

### Session å­˜å‚¨ä½ç½®

SDK ä¼šå°†å¯¹è¯å†å²ä¿å­˜åœ¨ï¼š

```
~/.claude-agent-sdk/sessions/
  â””â”€â”€ {session_id}/
      â””â”€â”€ transcript.jsonl  # å®Œæ•´çš„å¯¹è¯å†å²
```

æ¯æ¡æ¶ˆæ¯éƒ½ä¼šè¿½åŠ åˆ° transcript æ–‡ä»¶ä¸­ï¼Œæ ¼å¼ä¸º JSON Linesã€‚

---

## ğŸ†š å¯¹æ¯”æ€»ç»“

| ç‰¹æ€§             | ç‹¬ç«‹æ¨¡å¼         | æŒä¹…åŒ–æ¨¡å¼         |
| ---------------- | ---------------- | ------------------ |
| **è¿›ç¨‹ç®¡ç†**     | æ¯æ¬¡å¯åŠ¨æ–°è¿›ç¨‹   | å¸¸é©»è¿›ç¨‹           |
| **Session**      | æ¯æ¬¡éƒ½æ˜¯æ–°çš„     | åŒä¸€ä¸ª Session     |
| **AI è®°å¿†**      | ä¸è®°å¾—ä¹‹å‰çš„å¯¹è¯ | è®°ä½æ‰€æœ‰å†å²       |
| **å·¥å…·è°ƒç”¨å†å²** | ä¸ä¿ç•™           | å®Œæ•´ä¿ç•™           |
| **é€‚ç”¨åœºæ™¯**     | å•æ¬¡ä»»åŠ¡         | å¤šè½®å¯¹è¯ã€å¤æ‚ä»»åŠ¡ |
| **æ€§èƒ½**         | æ¯æ¬¡å¯åŠ¨æœ‰å»¶è¿Ÿ   | å“åº”æ›´å¿«           |
| **å®ç°å¤æ‚åº¦**   | ç®€å•             | ä¸­ç­‰               |

---

## ğŸ¯ æœ€ä½³å®è·µ

### 1. ä½•æ—¶ä½¿ç”¨æŒä¹…åŒ–æ¨¡å¼

âœ… **æ¨èåœºæ™¯ï¼š**

- éœ€è¦ AI è®°ä½ä¸Šä¸‹æ–‡çš„å¤šè½®å¯¹è¯
- å¤æ‚çš„ä»£ç åˆ†æä»»åŠ¡
- äº¤äº’å¼å¼€å‘è¾…åŠ©
- éœ€è¦è¿ç»­æ‰§è¡Œå¤šä¸ªç›¸å…³ä»»åŠ¡

âŒ **ä¸æ¨èåœºæ™¯ï¼š**

- å•æ¬¡ç‹¬ç«‹çš„æŸ¥è¯¢
- ä¸éœ€è¦å†å²ä¸Šä¸‹æ–‡
- æ‰¹å¤„ç†è„šæœ¬

### 2. Session ç®¡ç†å»ºè®®

```rust
// é•¿æ—¶é—´å¯¹è¯åï¼Œå¯ä»¥é‡ç½® Session
if turn_count > 50 {
    bridge.reset_session()?;
    println!("å¯¹è¯å¤ªé•¿äº†ï¼Œå·²é‡ç½®ä¼šè¯ä»¥æå‡æ€§èƒ½");
}
```

### 3. é”™è¯¯å¤„ç†

```rust
match bridge.send_message(user_input, workspace) {
    Ok(response) => {
        if !response["success"].as_bool().unwrap_or(false) {
            // å¤„ç† API é”™è¯¯
            eprintln!("API é”™è¯¯: {:?}", response["error"]);

            // å¯ä»¥é€‰æ‹©é‡ç½®ä¼šè¯
            bridge.reset_session()?;
        }
    }
    Err(e) => {
        // å¤„ç†é€šä¿¡é”™è¯¯
        eprintln!("é€šä¿¡é”™è¯¯: {}", e);

        // å¯èƒ½éœ€è¦é‡å¯ Bridge
        bridge = PersistentAgentBridge::new()?;
    }
}
```

---

## ğŸ› æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: Bridge æœªç¼–è¯‘

```bash
é”™è¯¯: æ‰¾ä¸åˆ° mcp-agent-bridge-persistent.js

è§£å†³:
cd scripts
pnpm run build:mcp-persistent
```

### é—®é¢˜ 2: MCP æœåŠ¡å™¨æœªç¼–è¯‘

```bash
é”™è¯¯: æ‰¾ä¸åˆ° codebase-mcp-server

è§£å†³:
cd src-tauri
cargo build --release --bin codebase-mcp-server
```

### é—®é¢˜ 3: Session ä¸¢å¤±

```bash
ç°è±¡: AI ä¸è®°å¾—ä¹‹å‰çš„å¯¹è¯

å¯èƒ½åŸå› :
1. session_id æœªæ­£ç¡®ä¿å­˜
2. Bridge è¿›ç¨‹æ„å¤–é‡å¯
3. transcript æ–‡ä»¶è¢«åˆ é™¤

è§£å†³:
- æ£€æŸ¥ session_id æ˜¯å¦ä¸€è‡´ï¼ˆä½¿ç”¨ 'info' å‘½ä»¤ï¼‰
- ç¡®ä¿ Bridge è¿›ç¨‹æ²¡æœ‰é‡å¯
```

### é—®é¢˜ 4: API Key é”™è¯¯

```bash
é”™è¯¯: 401 Unauthorized

è§£å†³:
1. æ£€æŸ¥ .env æ–‡ä»¶ä¸­çš„ ANTHROPIC_API_KEY
2. æˆ–è®¾ç½®ç¯å¢ƒå˜é‡:
   export ANTHROPIC_API_KEY="your-key-here"
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Claude Agent SDK æ·±åº¦è§£æ](./CLAUDE_AGENT_SDK_DEEP_DIVE.md)
- [å®Œæ•´æ¶æ„æ–‡æ¡£](./COMPLETE_ARCHITECTURE.md)
- [å¿«é€Ÿè®¾ç½®æŒ‡å—](./QUICK_SETUP.md)
- [Router è®¾ç½®æŒ‡å—](./SETUP_ROUTER.md)

---

## ğŸ‰ æ€»ç»“

é€šè¿‡ä½¿ç”¨ SDK çš„ `resume` åŠŸèƒ½ï¼Œæˆ‘ä»¬å®ç°äº†çœŸæ­£çš„æŒä¹…åŒ–å¤šè½®å¯¹è¯ï¼š

âœ… **æ‰€æœ‰å¯¹è¯éƒ½åœ¨åŒä¸€ä¸ª Session ä¸­**  
âœ… **AI å®Œæ•´è®°ä½æ‰€æœ‰å†å²å¯¹è¯**  
âœ… **æ”¯æŒå·¥å…·è°ƒç”¨å†å²è¿½è¸ª**  
âœ… **æ›´å¿«çš„å“åº”é€Ÿåº¦ï¼ˆè¿›ç¨‹å¤ç”¨ï¼‰**

äº«å—ä½ çš„ AI åŠ©æ‰‹å§ï¼ğŸš€
