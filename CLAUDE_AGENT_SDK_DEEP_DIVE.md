# @anthropic-ai/claude-agent-sdk æ·±åº¦è§£ææ–‡æ¡£

## ğŸ“– æ–‡æ¡£æ¦‚è¿°

æœ¬æ–‡æ¡£åŸºäº `@anthropic-ai/claude-agent-sdk@0.1.5` çš„æœ¬åœ°æºç åˆ†æå’Œå®˜æ–¹æ–‡æ¡£ç ”ç©¶ï¼Œè¯¦ç»†è§£æè¿™ä¸ªç”± Anthropic å®˜æ–¹æä¾›çš„ AI Agent å¼€å‘å·¥å…·åŒ…çš„æ ¸å¿ƒæ¶æ„ã€åŠŸèƒ½æ¨¡å—å’Œè®¾è®¡ç†å¿µã€‚

---

## 1. SDK åŸºæœ¬ä¿¡æ¯

### 1.1 åŒ…ä¿¡æ¯

- **åŒ…å**: `@anthropic-ai/claude-agent-sdk`
- **ç‰ˆæœ¬**: 0.1.5
- **ä¸»å…¥å£**: `sdk.mjs` (ES Module)
- **ç±»å‹å®šä¹‰**: `sdk.d.ts`
- **Node.js è¦æ±‚**: >= 18.0.0
- **å¼€æºåœ°å€**: https://github.com/anthropics/claude-code
- **å®˜æ–¹æ–‡æ¡£**: https://docs.claude.com/en/api/agent-sdk/overview

### 1.2 æ ¸å¿ƒå®šä½

è¿™æ˜¯ä¸€ä¸ª**ç”Ÿäº§çº§ AI Agent å¼€å‘æ¡†æ¶**ï¼Œå®ƒå°† Claude Codeï¼ˆAnthropic çš„ AI ç¼–ç¨‹åŠ©æ‰‹äº§å“ï¼‰çš„æ ¸å¿ƒèƒ½åŠ›å°è£…ä¸ºå¯ç¼–ç¨‹çš„ SDKï¼Œè®©å¼€å‘è€…èƒ½å¤Ÿï¼š

1. **æ— éœ€ UI**ï¼šä»¥ä»£ç æ–¹å¼è°ƒç”¨ Claude Code çš„æ‰€æœ‰åŠŸèƒ½
2. **è‡ªåŠ¨åŒ–å·¥ä½œæµ**ï¼šæ„å»ºè‡ªä¸»çš„ AI Agent æ‰§è¡Œå¤æ‚ä»»åŠ¡
3. **å®Œæ•´æ§åˆ¶**ï¼šé€šè¿‡é’©å­å’Œæƒé™ç³»ç»Ÿç²¾ç»†æ§åˆ¶ Agent è¡Œä¸º
4. **ç”Ÿäº§å°±ç»ª**ï¼šå†…ç½®é”™è¯¯å¤„ç†ã€ä¼šè¯ç®¡ç†ã€æˆæœ¬è¿½è¸ª

---

## 2. SDK æ ¸å¿ƒæ¶æ„

### 2.1 æ•´ä½“æ¶æ„è®¾è®¡

SDK é‡‡ç”¨**åˆ†å±‚æ¶æ„**ï¼Œä»åº•å±‚åˆ°ä¸Šå±‚ä¾æ¬¡ä¸ºï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           ç”¨æˆ·ä»£ç  (User Code)                      â”‚
â”‚           const response = query(...)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         SDK æ ¸å¿ƒå±‚ (sdk.mjs)                        â”‚
â”‚  â€¢ query() - ä¸»å…¥å£å‡½æ•°                             â”‚
â”‚  â€¢ AsyncGenerator æµå¼æ¥å£                          â”‚
â”‚  â€¢ æ§åˆ¶å‘½ä»¤ (interrupt/setModel...)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Claude Code å¯æ‰§è¡Œæ–‡ä»¶                         â”‚
â”‚      (å†…ç½®çš„ Claude Code CLI)                       â”‚
â”‚  â€¢ å·¥å…·æ‰§è¡Œå¼•æ“                                     â”‚
â”‚  â€¢ Agent è‡ªä¸»å¾ªç¯                                   â”‚
â”‚  â€¢ æƒé™ç³»ç»Ÿ                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        Claude API (Anthropic)                       â”‚
â”‚        é€šè¿‡ Messages API ä¸æ¨¡å‹äº¤äº’                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®è®¾è®¡ç†å¿µ**ï¼š

1. **CLI åŒ…è£…**ï¼šSDK æœ¬è´¨ä¸Šæ˜¯å¯¹ Claude Code CLI çš„å¯ç¼–ç¨‹åŒ…è£…
2. **æµå¼é€šä¿¡**ï¼šä½¿ç”¨ AsyncGenerator å®ç°æµå¼æ¶ˆæ¯ä¼ é€’
3. **è¿›ç¨‹éš”ç¦»**ï¼šClaude Code åœ¨ç‹¬ç«‹è¿›ç¨‹ä¸­è¿è¡Œï¼ŒSDK é€šè¿‡è¿›ç¨‹é—´é€šä¿¡æ§åˆ¶
4. **å·¥å…·è‡ªåŠ¨åŒ–**ï¼šæ‰€æœ‰å·¥å…·æ‰§è¡Œéƒ½åœ¨ Claude Code è¿›ç¨‹å†…è‡ªåŠ¨å®Œæˆ

### 2.2 æ–‡ä»¶ç»“æ„

```
@anthropic-ai/claude-agent-sdk/
â”œâ”€â”€ sdk.mjs                    # ä¸»å…¥å£ï¼Œæ ¸å¿ƒé€»è¾‘
â”œâ”€â”€ sdk.d.ts                   # TypeScript ç±»å‹å®šä¹‰
â”œâ”€â”€ sdkTypes.d.ts              # è¯¦ç»†çš„ç±»å‹ç³»ç»Ÿ
â”œâ”€â”€ sdk-tools.d.ts             # å·¥å…·ç›¸å…³ç±»å‹
â”œâ”€â”€ cli.js                     # CLI å·¥å…·ï¼ˆå¯é€‰ï¼‰
â”œâ”€â”€ vendor/                    # å†…ç½®ä¾èµ–
â”‚   â”œâ”€â”€ claude-code-jetbrains-plugin/  # JetBrains æ’ä»¶
â”‚   â””â”€â”€ ripgrep/               # é«˜æ€§èƒ½æ–‡æœ¬æœç´¢å·¥å…·
â”‚       â”œâ”€â”€ arm64-darwin/      # å„å¹³å°çš„ ripgrep äºŒè¿›åˆ¶
â”‚       â”œâ”€â”€ x64-darwin/
â”‚       â”œâ”€â”€ arm64-linux/
â”‚       â””â”€â”€ x64-win32/
â””â”€â”€ yoga.wasm                  # å¸ƒå±€å¼•æ“ï¼ˆUI ç›¸å…³ï¼‰
```

**é‡è¦å‘ç°**ï¼š

- **å†…ç½® ripgrep**ï¼šä¸º grep å·¥å…·æä¾›é«˜æ€§èƒ½æ”¯æŒ
- **JetBrains æ’ä»¶**ï¼šè¡¨æ˜ SDK å¯èƒ½ä¸ IDE é›†æˆå…±äº«æ ¸å¿ƒé€»è¾‘
- **yoga.wasm**ï¼šå¸ƒå±€å¼•æ“ï¼Œå¯èƒ½ç”¨äºæ¸²æŸ“ç»ˆç«¯ UI æˆ–ä»£ç ç¼–è¾‘å™¨ç•Œé¢
- **æ—  dependencies**ï¼šé›¶ä¾èµ–è®¾è®¡ï¼Œæ‰€æœ‰åŠŸèƒ½è‡ªåŒ…å«

---

## 3. æ ¸å¿ƒåŠŸèƒ½æ¨¡å—

### 3.1 ä¸»å…¥å£å‡½æ•°ï¼šquery()

è¿™æ˜¯ SDK çš„**å”¯ä¸€å…¬å¼€ API**ï¼Œè®¾è®¡æå…¶ç®€æ´ï¼š

**å‡½æ•°ç­¾å**ï¼š
```typescript
function query({
    prompt: string | AsyncIterable<SDKUserMessage>,
    options?: Options
}): Query
```

**è¿”å›å€¼**ï¼š`Query` - ä¸€ä¸ª AsyncGeneratorï¼Œå¯ä»¥æµå¼æ¥æ”¶æ¶ˆæ¯

**æ ¸å¿ƒç‰¹ç‚¹**ï¼š

1. **æµå¼æ¥å£**ï¼šä¸æ˜¯è¿”å›å•ä¸ªç»“æœï¼Œè€Œæ˜¯è¿”å›ä¸€ä¸ªå¼‚æ­¥ç”Ÿæˆå™¨
2. **çµæ´»è¾“å…¥**ï¼šæ”¯æŒç®€å•å­—ç¬¦ä¸²æˆ–å¤æ‚çš„æ¶ˆæ¯æµ
3. **ä¸°å¯Œé…ç½®**ï¼šé€šè¿‡ options æ§åˆ¶ Agent çš„æ‰€æœ‰è¡Œä¸º

### 3.2 æ¶ˆæ¯ç³»ç»Ÿ (SDKMessage)

SDK å®šä¹‰äº† **8 ç§æ¶ˆæ¯ç±»å‹**ï¼Œè¦†ç›– Agent ç”Ÿå‘½å‘¨æœŸçš„æ‰€æœ‰é˜¶æ®µï¼š

#### 1. **SDKSystemMessage** - ç³»ç»Ÿåˆå§‹åŒ–
```typescript
{
    type: 'system',
    subtype: 'init',
    apiKeySource: 'user' | 'project' | 'org',
    cwd: string,              // å·¥ä½œç›®å½•
    tools: string[],          // å¯ç”¨å·¥å…·åˆ—è¡¨
    mcp_servers: {...},       // MCP æœåŠ¡å™¨çŠ¶æ€
    model: string,            // ä½¿ç”¨çš„æ¨¡å‹
    permissionMode: string,   // æƒé™æ¨¡å¼
    slash_commands: string[]  // æ–œæ å‘½ä»¤
}
```
**ä½œç”¨**ï¼šå‘ŠçŸ¥ Agent çš„åˆå§‹é…ç½®å’Œç¯å¢ƒ

#### 2. **SDKUserMessage** - ç”¨æˆ·æ¶ˆæ¯
```typescript
{
    type: 'user',
    message: APIUserMessage,  // ç”¨æˆ·è¾“å…¥
    parent_tool_use_id: string | null,  // çˆ¶å·¥å…·è°ƒç”¨ ID
    isSynthetic?: boolean     // æ˜¯å¦ä¸ºç³»ç»Ÿåˆæˆæ¶ˆæ¯
}
```
**ä½œç”¨**ï¼šè¡¨ç¤ºç”¨æˆ·è¾“å…¥æˆ–å·¥å…·æ‰§è¡Œç»“æœï¼ˆtool_resultï¼‰

#### 3. **SDKAssistantMessage** - AI å“åº”
```typescript
{
    type: 'assistant',
    message: {
        content: [
            { type: 'text', text: '...' },
            { type: 'tool_use', name: 'bash', input: {...} }
        ]
    },
    parent_tool_use_id: string | null
}
```
**ä½œç”¨**ï¼šAI çš„æ–‡æœ¬å“åº”æˆ–å·¥å…·è°ƒç”¨è¯·æ±‚

#### 4. **SDKPartialAssistantMessage** - æµå¼ç‰‡æ®µ
```typescript
{
    type: 'stream_event',
    event: RawMessageStreamEvent  // åŸå§‹æµå¼äº‹ä»¶
}
```
**ä½œç”¨**ï¼šå®æ—¶æµå¼è¾“å‡ºï¼Œå¯ä»¥è·å¾—éƒ¨åˆ†å“åº”

#### 5. **SDKResultMessage** - æœ€ç»ˆç»“æœ
```typescript
{
    type: 'result',
    subtype: 'success' | 'error_max_turns' | 'error_during_execution',
    duration_ms: number,         // æ€»è€—æ—¶
    duration_api_ms: number,     // API è€—æ—¶
    num_turns: number,           // å¯¹è¯è½®æ•°
    total_cost_usd: number,      // æ€»æˆæœ¬
    usage: {
        input_tokens: number,
        output_tokens: number,
        cache_read_input_tokens: number,
        cache_creation_input_tokens: number
    },
    modelUsage: {
        [modelName: string]: {
            inputTokens: number,
            outputTokens: number,
            costUSD: number,
            webSearchRequests: number
        }
    },
    permission_denials: [...]    // è¢«æ‹’ç»çš„æƒé™è¯·æ±‚
}
```
**ä½œç”¨**ï¼šä»»åŠ¡å®Œæˆæ—¶çš„ç»Ÿè®¡ä¿¡æ¯

#### 6. **SDKUserMessageReplay** - æ¶ˆæ¯ç¡®è®¤
```typescript
{
    type: 'user',
    isReplay: true  // æ ‡è®°ä¸ºé‡æ”¾æ¶ˆæ¯
}
```
**ä½œç”¨**ï¼šé˜²æ­¢é‡å¤å¤„ç†å·²æ·»åŠ çš„ç”¨æˆ·æ¶ˆæ¯

#### 7. **SDKCompactBoundaryMessage** - å‹ç¼©è¾¹ç•Œ
```typescript
{
    type: 'system',
    subtype: 'compact_boundary',
    compact_metadata: {
        trigger: 'manual' | 'auto',
        pre_tokens: number  // å‹ç¼©å‰çš„ token æ•°
    }
}
```
**ä½œç”¨**ï¼šå½“å¯¹è¯å†å²è¢«å‹ç¼©æ—¶çš„æ ‡è®°

#### 8. **SDKPermissionDenial** - æƒé™æ‹’ç»
```typescript
{
    tool_name: string,
    tool_use_id: string,
    tool_input: Record<string, unknown>
}
```
**ä½œç”¨**ï¼šè®°å½•è¢«ç”¨æˆ·æ‹’ç»çš„å·¥å…·è°ƒç”¨

---

## 4. å†…ç½®å·¥å…·ç³»ç»Ÿ

SDK å†…ç½®äº† **17 ç§å·¥å…·**ï¼Œå®Œå…¨è‡ªåŠ¨æ‰§è¡Œï¼Œæ— éœ€å¼€å‘è€…å®ç°ï¼š

### 4.1 æ–‡ä»¶æ“ä½œå·¥å…· (File Tools)

#### 1. **file_read** - è¯»å–æ–‡ä»¶
- **èƒ½åŠ›**ï¼šæ”¯æŒå¤§æ–‡ä»¶çš„åˆ†é¡µè¯»å–ï¼ˆoffset/limitï¼‰
- **è·¯å¾„è¦æ±‚**ï¼šå¿…é¡»æ˜¯ç»å¯¹è·¯å¾„

#### 2. **file_write** - å†™å…¥æ–‡ä»¶
- **èƒ½åŠ›**ï¼šåˆ›å»ºæ–°æ–‡ä»¶æˆ–è¦†ç›–ç°æœ‰æ–‡ä»¶
- **è·¯å¾„è¦æ±‚**ï¼šå¿…é¡»æ˜¯ç»å¯¹è·¯å¾„
- **è‡ªåŠ¨å¤„ç†**ï¼šè‡ªåŠ¨åˆ›å»ºçˆ¶ç›®å½•

#### 3. **file_edit** - ç¼–è¾‘æ–‡ä»¶
- **èƒ½åŠ›**ï¼šå­—ç¬¦ä¸²æœç´¢æ›¿æ¢
- **é€‰é¡¹**ï¼šæ”¯æŒæ›¿æ¢é¦–ä¸ªæˆ–å…¨éƒ¨åŒ¹é…
- **ç²¾ç¡®æ€§**ï¼šè¦æ±‚ `old_string` å¿…é¡»åœ¨æ–‡ä»¶ä¸­å”¯ä¸€åŒ¹é…

#### 4. **notebook_edit** - ç¼–è¾‘ Jupyter Notebook
- **èƒ½åŠ›**ï¼šç¼–è¾‘ã€æ’å…¥ã€åˆ é™¤ notebook å•å…ƒæ ¼
- **æ”¯æŒç±»å‹**ï¼šcode å’Œ markdown å•å…ƒæ ¼
- **çµæ´»æ€§**ï¼šåŸºäº cell_id å®šä½

### 4.2 ä»£ç æ‰§è¡Œå·¥å…· (Execution Tools)

#### 5. **bash** - æ‰§è¡Œå‘½ä»¤
- **èƒ½åŠ›**ï¼š
  - åŒæ­¥æ‰§è¡Œï¼ˆé»˜è®¤ï¼‰
  - åå°æ‰§è¡Œï¼ˆ`run_in_background: true`ï¼‰
  - è¶…æ—¶æ§åˆ¶ï¼ˆæœ€å¤§ 600 ç§’ï¼‰
- **å¿…éœ€å‚æ•°**ï¼š`description` - å‘½ä»¤çš„ç®€çŸ­æè¿°
- **å®‰å…¨æ€§**ï¼šé€šè¿‡æƒé™ç³»ç»Ÿæ§åˆ¶

#### 6. **bash_output** - è¯»å–åå°ä»»åŠ¡è¾“å‡º
- **èƒ½åŠ›**ï¼šè¯»å–åå° bash ä»»åŠ¡çš„è¾“å‡º
- **è¿‡æ»¤**ï¼šæ”¯æŒæ­£åˆ™è¡¨è¾¾å¼è¿‡æ»¤
- **å®æ—¶æ€§**ï¼šå¯ä»¥å¤šæ¬¡è¯»å–åŒä¸€ä»»åŠ¡çš„è¾“å‡º

#### 7. **kill_shell** - ç»ˆæ­¢åå°ä»»åŠ¡
- **èƒ½åŠ›**ï¼šå¼ºåˆ¶ç»ˆæ­¢æŒ‡å®šçš„åå° bash è¿›ç¨‹

### 4.3 æœç´¢å·¥å…· (Search Tools)

#### 8. **grep** - æ–‡æœ¬æœç´¢
- **åº•å±‚å®ç°**ï¼šåŸºäº ripgrepï¼ˆé«˜æ€§èƒ½ Rust å®ç°ï¼‰
- **èƒ½åŠ›**ï¼š
  - æ­£åˆ™è¡¨è¾¾å¼æœç´¢
  - Glob æ¨¡å¼è¿‡æ»¤æ–‡ä»¶
  - ä¸Šä¸‹æ–‡è¡Œæ§åˆ¶ï¼ˆ-A/-B/-Cï¼‰
  - å¤§å°å†™ä¸æ•æ„Ÿï¼ˆ-iï¼‰
  - å¤šè¡Œæ¨¡å¼ï¼ˆmultilineï¼‰
- **è¾“å‡ºæ¨¡å¼**ï¼š
  - `content` - åŒ¹é…çš„è¡Œå†…å®¹
  - `files_with_matches` - ä»…æ–‡ä»¶è·¯å¾„
  - `count` - åŒ¹é…è®¡æ•°
- **æ€§èƒ½ä¼˜åŒ–**ï¼šå†…ç½® `head_limit` é™åˆ¶è¾“å‡ºé‡

#### 9. **glob** - æ–‡ä»¶ååŒ¹é…
- **èƒ½åŠ›**ï¼šåŸºäº glob æ¨¡å¼æŸ¥æ‰¾æ–‡ä»¶
- **æ¨¡å¼æ”¯æŒ**ï¼š
  - `*.js` - æ‰€æœ‰ JS æ–‡ä»¶
  - `**/*.ts` - é€’å½’æ‰€æœ‰ TS æ–‡ä»¶
  - `src/**/*.{js,ts}` - å¤šæ‰©å±•å
- **æ€§èƒ½**ï¼šåŸºäºä¿®æ”¹æ—¶é—´æ’åº

### 4.4 ç½‘ç»œå·¥å…· (Web Tools)

#### 10. **web_search** - ç½‘ç»œæœç´¢
- **èƒ½åŠ›**ï¼š
  - ä½¿ç”¨æœç´¢å¼•æ“æŸ¥è¯¢
  - åŸŸåç™½åå•/é»‘åå•
- **é›†æˆ**ï¼šä¸ Claude çš„æœç´¢èƒ½åŠ›æ·±åº¦æ•´åˆ

#### 11. **web_fetch** - æŠ“å–ç½‘é¡µ
- **èƒ½åŠ›**ï¼š
  - è·å–ç½‘é¡µå†…å®¹
  - å¯¹å†…å®¹æ‰§è¡Œ promptï¼ˆå¦‚æå–æ‘˜è¦ï¼‰
- **æ™ºèƒ½å¤„ç†**ï¼šè‡ªåŠ¨è§£æ HTML ä¸ºå¯è¯»æ–‡æœ¬

### 4.5 MCP å·¥å…· (Model Context Protocol)

#### 12. **mcp** - MCP å·¥å…·è°ƒç”¨
- **èƒ½åŠ›**ï¼šè°ƒç”¨é€šè¿‡ MCP åè®®è¿æ¥çš„å¤–éƒ¨å·¥å…·
- **çµæ´»æ€§**ï¼šè¾“å…¥æ ¼å¼ç”± MCP æœåŠ¡å™¨å®šä¹‰

#### 13. **list_mcp_resources** - åˆ—å‡º MCP èµ„æº
- **èƒ½åŠ›**ï¼šæŸ¥è¯¢å¯ç”¨çš„ MCP èµ„æº

#### 14. **read_mcp_resource** - è¯»å– MCP èµ„æº
- **èƒ½åŠ›**ï¼šé€šè¿‡ URI è¯»å– MCP èµ„æºå†…å®¹

### 4.6 ä»»åŠ¡ç®¡ç†å·¥å…·

#### 15. **todo_write** - ç®¡ç†å¾…åŠäº‹é¡¹
- **èƒ½åŠ›**ï¼š
  - åˆ›å»ºã€æ›´æ–°å¾…åŠåˆ—è¡¨
  - è·Ÿè¸ªä»»åŠ¡çŠ¶æ€ï¼ˆpending/in_progress/completedï¼‰
- **ç”¨é€”**ï¼šAgent è‡ªä¸»ç®¡ç†å¤æ‚ä»»åŠ¡çš„æ‹†è§£

#### 16. **agent** - å­ Agent è°ƒç”¨
- **èƒ½åŠ›**ï¼šåˆ›å»ºä¸“é—¨çš„å­ Agent æ‰§è¡Œç‰¹å®šä»»åŠ¡
- **å‚æ•°**ï¼š
  - `subagent_type` - Agent ç±»å‹
  - `description` - ä»»åŠ¡æè¿°ï¼ˆ3-5 è¯ï¼‰
  - `prompt` - å…·ä½“ä»»åŠ¡
- **ç”¨é€”**ï¼šå®ç°ä»»åŠ¡å§”æ´¾å’Œå¹¶è¡Œå¤„ç†

#### 17. **exit_plan_mode** - é€€å‡ºè®¡åˆ’æ¨¡å¼
- **èƒ½åŠ›**ï¼šåœ¨è®¡åˆ’æ¨¡å¼ä¸‹æäº¤è®¡åˆ’ä¾›ç”¨æˆ·å®¡æ‰¹
- **å‚æ•°**ï¼š`plan` - Markdown æ ¼å¼çš„è®¡åˆ’

---

## 5. æƒé™ç³»ç»Ÿ (Permission System)

è¿™æ˜¯ SDK æœ€ç²¾å¦™çš„è®¾è®¡ä¹‹ä¸€ï¼Œæä¾›äº†**å¤šå±‚æ¬¡çš„å®‰å…¨æ§åˆ¶**ã€‚

### 5.1 æƒé™æ¨¡å¼ (PermissionMode)

SDK å®šä¹‰äº† **4 ç§æƒé™æ¨¡å¼**ï¼š

#### 1. **default** - é»˜è®¤æ¨¡å¼
- **è¡Œä¸º**ï¼šæ ¹æ®ç”¨æˆ·é…ç½®çš„æƒé™è§„åˆ™å†³å®š
- **äº¤äº’**ï¼šå¯èƒ½æç¤ºç”¨æˆ·æ‰¹å‡†å·¥å…·è°ƒç”¨
- **é€‚ç”¨**ï¼šæ—¥å¸¸å¼€å‘åœºæ™¯

#### 2. **acceptEdits** - è‡ªåŠ¨æ¥å—ç¼–è¾‘
- **è¡Œä¸º**ï¼šè‡ªåŠ¨æ‰¹å‡†æ‰€æœ‰æ–‡ä»¶ç¼–è¾‘æ“ä½œ
- **é™åˆ¶**ï¼šbash å‘½ä»¤ä»éœ€æ‰¹å‡†
- **é€‚ç”¨**ï¼šä»£ç é‡æ„ã€æ‰¹é‡ä¿®æ”¹

#### 3. **bypassPermissions** - å®Œå…¨ç»•è¿‡
- **è¡Œä¸º**ï¼šæ— éœ€ä»»ä½•æ‰¹å‡†ï¼Œè‡ªåŠ¨æ‰§è¡Œæ‰€æœ‰å·¥å…·
- **é£é™©**ï¼šé«˜é£é™©ï¼Œä»…ç”¨äºå®Œå…¨å¯ä¿¡ç¯å¢ƒ
- **é€‚ç”¨**ï¼šè‡ªåŠ¨åŒ–è„šæœ¬ã€CI/CD

#### 4. **plan** - è®¡åˆ’æ¨¡å¼
- **è¡Œä¸º**ï¼šAgent å…ˆç”Ÿæˆè®¡åˆ’ï¼Œç­‰å¾…ç”¨æˆ·æ‰¹å‡†åå†æ‰§è¡Œ
- **å®‰å…¨**ï¼šæœ€å®‰å…¨çš„æ¨¡å¼
- **é€‚ç”¨**ï¼šæ•æ„Ÿæ“ä½œã€ç”Ÿäº§ç¯å¢ƒ

### 5.2 æƒé™è§„åˆ™ (Permission Rules)

æƒé™è§„åˆ™ç”±**å·¥å…·åç§° + å†…å®¹åŒ¹é…**ç»„æˆï¼š

```typescript
{
    toolName: "bash",
    ruleContent: "git push"  // åŒ¹é…å‘½ä»¤ä¸­çš„ç‰¹å®šå­—ç¬¦ä¸²
}
```

**è§„åˆ™ç±»å‹**ï¼š

1. **allow** - ç™½åå•ï¼šè‡ªåŠ¨æ‰¹å‡†åŒ¹é…çš„å·¥å…·è°ƒç”¨
2. **deny** - é»‘åå•ï¼šè‡ªåŠ¨æ‹’ç»åŒ¹é…çš„å·¥å…·è°ƒç”¨
3. **ask** - è¯¢é—®ï¼šæç¤ºç”¨æˆ·å†³å®š

**è§„åˆ™å­˜å‚¨ä½ç½®** (PermissionUpdateDestination)ï¼š

- `session` - ä»…å½“å‰ä¼šè¯
- `localSettings` - å½“å‰é¡¹ç›®ï¼ˆ.claude/settings.local.jsonï¼‰
- `projectSettings` - é¡¹ç›®å…±äº«ï¼ˆ.claude/settings.project.jsonï¼‰
- `userSettings` - ç”¨æˆ·å…¨å±€ï¼ˆ~/.claude/settings.jsonï¼‰

### 5.3 åŠ¨æ€æƒé™æ§åˆ¶ï¼šcanUseTool å›è°ƒ

å¼€å‘è€…å¯ä»¥é€šè¿‡ `canUseTool` å›è°ƒå‡½æ•°å®ç°**è¿è¡Œæ—¶æƒé™æ§åˆ¶**ï¼š

```typescript
options: {
    canUseTool: async (toolName, input, options) => {
        // è‡ªå®šä¹‰é€»è¾‘åˆ¤æ–­æ˜¯å¦å…è®¸
        if (toolName === 'bash' && input.command.includes('rm -rf')) {
            return {
                behavior: 'deny',
                message: 'å±é™©å‘½ä»¤å·²è¢«æ‹’ç»',
                interrupt: true
            };
        }
        
        return {
            behavior: 'allow',
            updatedInput: input,  // å¯ä»¥ä¿®æ”¹å·¥å…·è¾“å…¥
            updatedPermissions: [...]  // å¯ä»¥æ›´æ–°æƒé™è§„åˆ™
        };
    }
}
```

**å…³é”®èƒ½åŠ›**ï¼š

1. **åŠ¨æ€åˆ¤æ–­**ï¼šåŸºäºä¸Šä¸‹æ–‡å†³å®šæƒé™
2. **è¾“å…¥ä¿®æ”¹**ï¼šåœ¨æ‰§è¡Œå‰ä¿®æ”¹å·¥å…·å‚æ•°
3. **è§„åˆ™æ›´æ–°**ï¼šåŠ¨æ€æ·»åŠ /åˆ é™¤æƒé™è§„åˆ™
4. **ä¸­æ–­æ‰§è¡Œ**ï¼šæ‹’ç»åå¯é€‰æ‹©ä¸­æ–­æ•´ä¸ªä»»åŠ¡

### 5.4 æƒé™æ‹’ç»è¿½è¸ª

æ‰€æœ‰è¢«æ‹’ç»çš„å·¥å…·è°ƒç”¨éƒ½ä¼šè¢«è®°å½•åœ¨æœ€ç»ˆç»“æœä¸­ï¼š

```typescript
{
    type: 'result',
    permission_denials: [
        {
            tool_name: 'bash',
            tool_use_id: 'toolu_123',
            tool_input: { command: 'rm -rf /' }
        }
    ]
}
```

---

## 6. é’©å­ç³»ç»Ÿ (Hooks System)

é’©å­ç³»ç»Ÿå…è®¸å¼€å‘è€…**ç›‘å¬å’Œå¹²é¢„** Agent æ‰§è¡Œçš„å„ä¸ªé˜¶æ®µã€‚

### 6.1 æ”¯æŒçš„é’©å­äº‹ä»¶

SDK å®šä¹‰äº† **9 ç§é’©å­äº‹ä»¶**ï¼š

#### 1. **PreToolUse** - å·¥å…·è°ƒç”¨å‰
- **æ—¶æœº**ï¼šå·¥å…·å³å°†æ‰§è¡Œå‰
- **ç”¨é€”**ï¼š
  - è®°å½•å·¥å…·è°ƒç”¨æ—¥å¿—
  - ä¿®æ”¹å·¥å…·è¾“å…¥
  - å®æ–½é¢å¤–çš„æƒé™æ£€æŸ¥
- **å¯è¿”å›**ï¼š
  - `permissionDecision` - è¦†ç›–æƒé™å†³ç­–
  - `systemMessage` - å‘ AI å‘é€ç³»ç»Ÿæ¶ˆæ¯

#### 2. **PostToolUse** - å·¥å…·è°ƒç”¨å
- **æ—¶æœº**ï¼šå·¥å…·æ‰§è¡Œå®Œæˆå
- **ç”¨é€”**ï¼š
  - è®°å½•æ‰§è¡Œç»“æœ
  - æ·»åŠ é¢å¤–ä¸Šä¸‹æ–‡
  - é”™è¯¯å¤„ç†å’Œé‡è¯•é€»è¾‘
- **å¯è¿”å›**ï¼š
  - `additionalContext` - è¡¥å……ä¿¡æ¯ç»™ AI

#### 3. **Notification** - é€šçŸ¥äº‹ä»¶
- **æ—¶æœº**ï¼šAgent å‘é€é€šçŸ¥æ—¶
- **ç”¨é€”**ï¼š
  - æ•è· Agent çš„é€šçŸ¥æ¶ˆæ¯
  - å®ç°è‡ªå®šä¹‰é€šçŸ¥ç³»ç»Ÿ
- **æ•°æ®**ï¼š
  - `message` - é€šçŸ¥å†…å®¹
  - `title` - é€šçŸ¥æ ‡é¢˜

#### 4. **UserPromptSubmit** - ç”¨æˆ·è¾“å…¥æäº¤
- **æ—¶æœº**ï¼šç”¨æˆ·æ¶ˆæ¯æäº¤ç»™ Agent å‰
- **ç”¨é€”**ï¼š
  - å¢å¼ºç”¨æˆ·è¾“å…¥
  - æ·»åŠ ä¸Šä¸‹æ–‡ä¿¡æ¯
- **å¯è¿”å›**ï¼š
  - `additionalContext` - è¡¥å……ç»™ AI çš„ä¸Šä¸‹æ–‡

#### 5. **SessionStart** - ä¼šè¯å¼€å§‹
- **æ—¶æœº**ï¼šAgent ä¼šè¯å¯åŠ¨æ—¶
- **ç”¨é€”**ï¼š
  - åˆå§‹åŒ–æ—¥å¿—ç³»ç»Ÿ
  - åŠ è½½å†å²ä¸Šä¸‹æ–‡
- **æ•°æ®**ï¼š
  - `source` - å¯åŠ¨æ¥æºï¼ˆstartup/resume/clear/compactï¼‰

#### 6. **SessionEnd** - ä¼šè¯ç»“æŸ
- **æ—¶æœº**ï¼šAgent ä¼šè¯ç»ˆæ­¢æ—¶
- **ç”¨é€”**ï¼š
  - æ¸…ç†èµ„æº
  - ä¿å­˜ä¼šè¯æ—¥å¿—
- **æ•°æ®**ï¼š
  - `reason` - ç»“æŸåŸå› ï¼ˆsuccess/error/timeout...ï¼‰

#### 7. **Stop** - åœæ­¢è¯·æ±‚
- **æ—¶æœº**ï¼šç”¨æˆ·è¯·æ±‚åœæ­¢ Agent æ—¶
- **ç”¨é€”**ï¼š
  - å®ç°ä¼˜é›…å…³é—­
  - ä¿å­˜ä¸­é—´çŠ¶æ€

#### 8. **SubagentStop** - å­ Agent åœæ­¢
- **æ—¶æœº**ï¼šå­ Agent åœæ­¢æ—¶
- **ç”¨é€”**ï¼šè·Ÿè¸ªå­ä»»åŠ¡çŠ¶æ€

#### 9. **PreCompact** - å‹ç¼©å‰
- **æ—¶æœº**ï¼šå¯¹è¯å†å²å³å°†è¢«å‹ç¼©æ—¶
- **ç”¨é€”**ï¼š
  - ä¿å­˜å®Œæ•´å†å²
  - è‡ªå®šä¹‰å‹ç¼©é€»è¾‘
- **æ•°æ®**ï¼š
  - `trigger` - è§¦å‘æ–¹å¼ï¼ˆmanual/autoï¼‰
  - `pre_tokens` - å‹ç¼©å‰çš„ token æ•°

### 6.2 é’©å­å›è°ƒæ ¼å¼

é’©å­å›è°ƒå‡½æ•°ç­¾åï¼š

```typescript
type HookCallback = (
    input: HookInput,           // äº‹ä»¶æ•°æ®
    toolUseID: string | undefined,  // å·¥å…·è°ƒç”¨ IDï¼ˆå¦‚é€‚ç”¨ï¼‰
    options: {
        signal: AbortSignal     // å¯ç”¨äºä¸­æ–­
    }
) => Promise<HookJSONOutput>
```

**è¿”å›å€¼ç±»å‹**ï¼š

1. **åŒæ­¥é’©å­** (SyncHookJSONOutput)ï¼š
```typescript
{
    continue?: boolean,         // æ˜¯å¦ç»§ç»­æ‰§è¡Œ
    suppressOutput?: boolean,   // æ˜¯å¦æŠ‘åˆ¶è¾“å‡º
    stopReason?: string,        // åœæ­¢åŸå› 
    decision?: 'approve' | 'block',  // å†³ç­–
    systemMessage?: string,     // å‘é€ç»™ AI çš„æ¶ˆæ¯
    hookSpecificOutput?: {...}  // ç‰¹å®šé’©å­çš„è¾“å‡º
}
```

2. **å¼‚æ­¥é’©å­** (AsyncHookJSONOutput)ï¼š
```typescript
{
    async: true,
    asyncTimeout?: number  // å¼‚æ­¥è¶…æ—¶ï¼ˆæ¯«ç§’ï¼‰
}
```

### 6.3 é’©å­åŒ¹é…å™¨ (Hook Matchers)

å¯ä»¥ä¸ºç‰¹å®šå·¥å…·è®¾ç½®é’©å­ï¼š

```typescript
options: {
    hooks: {
        PreToolUse: [
            {
                matcher: 'bash',  // ä»…åŒ¹é… bash å·¥å…·
                hooks: [bashPreHook]
            },
            {
                matcher: 'file_write',
                hooks: [fileWritePreHook]
            },
            {
                // æ—  matcherï¼ŒåŒ¹é…æ‰€æœ‰å·¥å…·
                hooks: [globalPreHook]
            }
        ]
    }
}
```

---

## 7. MCP (Model Context Protocol) æ”¯æŒ

### 7.1 MCP ç®€ä»‹

MCP æ˜¯ Anthropic å®šä¹‰çš„ä¸€ä¸ªå¼€æ”¾åè®®ï¼Œç”¨äº**æ‰©å±• AI Agent çš„èƒ½åŠ›**ã€‚é€šè¿‡ MCPï¼ŒAgent å¯ä»¥ï¼š

- è¿æ¥åˆ°å¤–éƒ¨æ•°æ®æºï¼ˆæ•°æ®åº“ã€APIã€æ–‡ä»¶ç³»ç»Ÿï¼‰
- è°ƒç”¨å¤–éƒ¨å·¥å…·å’ŒæœåŠ¡
- è·å–åŠ¨æ€ä¸Šä¸‹æ–‡ä¿¡æ¯

### 7.2 MCP æœåŠ¡å™¨ç±»å‹

SDK æ”¯æŒ **4 ç§ MCP æœåŠ¡å™¨è¿æ¥æ–¹å¼**ï¼š

#### 1. **stdio** - æ ‡å‡†è¾“å…¥è¾“å‡º
```typescript
{
    type: 'stdio',
    command: 'path/to/mcp-server',
    args: ['--option', 'value'],
    env: { KEY: 'value' }
}
```
- **ç”¨é€”**ï¼šæœ¬åœ°äºŒè¿›åˆ¶ MCP æœåŠ¡å™¨
- **é€šä¿¡**ï¼šé€šè¿‡è¿›ç¨‹çš„ stdin/stdout

#### 2. **sse** - Server-Sent Events
```typescript
{
    type: 'sse',
    url: 'https://api.example.com/mcp/sse',
    headers: { 'Authorization': 'Bearer token' }
}
```
- **ç”¨é€”**ï¼šè¿œç¨‹ HTTP MCP æœåŠ¡å™¨
- **é€šä¿¡**ï¼šé€šè¿‡ SSE æµ

#### 3. **http** - HTTP è½®è¯¢
```typescript
{
    type: 'http',
    url: 'https://api.example.com/mcp',
    headers: { 'Authorization': 'Bearer token' }
}
```
- **ç”¨é€”**ï¼šæ ‡å‡† HTTP API
- **é€šä¿¡**ï¼šè¯·æ±‚/å“åº”æ¨¡å¼

#### 4. **sdk** - SDK å†…åµŒ
```typescript
{
    type: 'sdk',
    name: 'my-mcp-server',
    instance: mcpServerInstance
}
```
- **ç”¨é€”**ï¼šåœ¨åŒä¸€è¿›ç¨‹ä¸­è¿è¡Œçš„ MCP æœåŠ¡å™¨
- **é€šä¿¡**ï¼šç›´æ¥å‡½æ•°è°ƒç”¨

### 7.3 åˆ›å»ºè‡ªå®šä¹‰ MCP æœåŠ¡å™¨

SDK æä¾›äº† `createSdkMcpServer()` å’Œ `tool()` è¾…åŠ©å‡½æ•°ï¼š

```typescript
import { createSdkMcpServer, tool } from '@anthropic-ai/claude-agent-sdk';
import { z } from 'zod';

// å®šä¹‰å·¥å…·
const weatherTool = tool(
    'get_weather',
    'è·å–æŒ‡å®šåŸå¸‚çš„å¤©æ°”',
    {
        city: z.string().describe('åŸå¸‚åç§°'),
        unit: z.enum(['celsius', 'fahrenheit']).optional()
    },
    async (args) => {
        // å®ç°å·¥å…·é€»è¾‘
        const weather = await fetchWeather(args.city, args.unit);
        return {
            content: [{ 
                type: 'text', 
                text: `${args.city}çš„å¤©æ°”æ˜¯ï¼š${weather}` 
            }]
        };
    }
);

// åˆ›å»º MCP æœåŠ¡å™¨
const weatherMcp = createSdkMcpServer({
    name: 'weather-server',
    version: '1.0.0',
    tools: [weatherTool]
});

// ä½¿ç”¨
const response = query({
    prompt: 'æŸ¥è¯¢åŒ—äº¬çš„å¤©æ°”',
    options: {
        mcpServers: {
            weather: weatherMcp
        }
    }
});
```

**ä¼˜åŠ¿**ï¼š

- **ç±»å‹å®‰å…¨**ï¼šåŸºäº Zod çš„è¾“å…¥éªŒè¯
- **è¿›ç¨‹å†…**ï¼šæ— éœ€é¢å¤–è¿›ç¨‹ï¼Œæ€§èƒ½æœ€ä¼˜
- **çµæ´»**ï¼šå¯ä»¥è®¿é—® Node.js çš„æ‰€æœ‰èƒ½åŠ›

### 7.4 MCP æœåŠ¡å™¨çŠ¶æ€æŸ¥è¯¢

å¯ä»¥é€šè¿‡ `mcpServerStatus()` æŸ¥è¯¢ MCP æœåŠ¡å™¨çŠ¶æ€ï¼š

```typescript
const statuses = await response.mcpServerStatus();
// [
//     {
//         name: 'weather',
//         status: 'connected',
//         serverInfo: {
//             name: 'weather-server',
//             version: '1.0.0'
//         }
//     },
//     {
//         name: 'database',
//         status: 'failed'
//     }
// ]
```

---

## 8. é«˜çº§ç‰¹æ€§

### 8.1 ä¼šè¯ç®¡ç† (Session Management)

#### ä¼šè¯æŒä¹…åŒ–

æ¯ä¸ªä¼šè¯éƒ½æœ‰å”¯ä¸€çš„ `session_id`ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æ¢å¤ï¼š

```typescript
options: {
    resume: 'session_abc123',  // æ¢å¤æŒ‡å®šä¼šè¯
    resumeSessionAt: 'msg_xyz', // æ¢å¤åˆ°ç‰¹å®šæ¶ˆæ¯
    forkSession: true          // åˆ›å»ºä¼šè¯åˆ†æ”¯
}
```

**ç”¨é€”**ï¼š

- **é•¿æ—¶é—´ä»»åŠ¡**ï¼šä¸­æ–­åæ¢å¤
- **ä¼šè¯åˆ†æ”¯**ï¼šåœ¨ç‰¹å®šç‚¹åˆ›å»ºä¸åŒçš„æ‰§è¡Œè·¯å¾„
- **è°ƒè¯•**ï¼šé‡æ”¾å†å²ä¼šè¯

#### ä¼šè¯å‹ç¼© (Compaction)

å½“å¯¹è¯å†å²è¿‡é•¿æ—¶ï¼ŒSDK ä¼šè‡ªåŠ¨è§¦å‘å‹ç¼©ï¼š

- **è§¦å‘æ¡ä»¶**ï¼šToken æ•°æ¥è¿‘ä¸Šä¸‹æ–‡çª—å£é™åˆ¶
- **å‹ç¼©æ–¹å¼**ï¼šä½¿ç”¨ AI æ€»ç»“å†å²ï¼Œä¿ç•™å…³é”®ä¿¡æ¯
- **è¾¹ç•Œæ ‡è®°**ï¼šé€šè¿‡ `SDKCompactBoundaryMessage` æ ‡è¯†

å¯ä»¥é€šè¿‡ `PreCompact` é’©å­è‡ªå®šä¹‰å‹ç¼©è¡Œä¸ºã€‚

### 8.2 æµå¼è¾“å‡ºæ§åˆ¶

#### éƒ¨åˆ†æ¶ˆæ¯

é€šè¿‡ `includePartialMessages: true` å¯ä»¥æ¥æ”¶æµå¼ç‰‡æ®µï¼š

```typescript
for await (const message of response) {
    if (message.type === 'stream_event') {
        // å®æ—¶æ˜¾ç¤º AI çš„éƒ¨åˆ†è¾“å‡º
        console.log(message.event);
    }
}
```

**ç”¨é€”**ï¼šå®ç°æ‰“å­—æœºæ•ˆæœã€å®æ—¶åé¦ˆ

#### ä¸­æ–­æ‰§è¡Œ

å¯ä»¥é€šè¿‡ `interrupt()` æ–¹æ³•ä¸­æ–­æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ï¼š

```typescript
const response = query({ prompt: '...', options });

// 5 ç§’åä¸­æ–­
setTimeout(() => {
    response.interrupt();
}, 5000);

for await (const message of response) {
    // å¤„ç†æ¶ˆæ¯
}
```

### 8.3 åŠ¨æ€æ¨¡å‹åˆ‡æ¢

å¯ä»¥åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­åŠ¨æ€åˆ‡æ¢æ¨¡å‹ï¼š

```typescript
const response = query({ prompt: '...', options });

// åˆ‡æ¢åˆ°æ›´å¼ºå¤§çš„æ¨¡å‹
await response.setModel('claude-opus-4');

for await (const message of response) {
    // ...
}
```

### 8.4 è‡ªå®šä¹‰å¯æ‰§è¡Œæ–‡ä»¶

å¯ä»¥æŒ‡å®šä¸åŒçš„ JavaScript è¿è¡Œæ—¶ï¼š

```typescript
options: {
    executable: 'bun',  // æˆ– 'deno' / 'node'
    executableArgs: ['--experimental-feature']
}
```

### 8.5 Thinking Tokens

æ”¯æŒæ§åˆ¶ AI çš„"æ€è€ƒ"è¿‡ç¨‹ï¼š

```typescript
options: {
    maxThinkingTokens: 5000  // å…è®¸ AI ä½¿ç”¨æœ€å¤š 5000 token æ€è€ƒ
}
```

**ç”¨é€”**ï¼š

- **å¤æ‚æ¨ç†**ï¼šç»™ AI æ›´å¤š"æ€è€ƒç©ºé—´"
- **æˆæœ¬æ§åˆ¶**ï¼šé™åˆ¶æ€è€ƒ token é™ä½æˆæœ¬

### 8.6 Agent ç³»ç»Ÿ

é€šè¿‡ `agents` é€‰é¡¹å¯ä»¥å®šä¹‰ä¸“é—¨çš„å­ Agentï¼š

```typescript
options: {
    agents: {
        'code-reviewer': {
            description: 'ä»£ç å®¡æŸ¥ä¸“å®¶',
            tools: ['file_read', 'grep'],  // é™åˆ¶å·¥å…·
            prompt: 'ä½ æ˜¯ä¸€ä¸ªä»£ç å®¡æŸ¥ä¸“å®¶ï¼Œå…³æ³¨...',
            model: 'sonnet'  // å¯ä»¥ä½¿ç”¨ä¸åŒæ¨¡å‹
        },
        'test-writer': {
            description: 'æµ‹è¯•ç”¨ä¾‹ç¼–å†™ä¸“å®¶',
            tools: ['file_read', 'file_write'],
            prompt: 'ä½ æ“…é•¿ç¼–å†™å…¨é¢çš„æµ‹è¯•ç”¨ä¾‹...',
            model: 'haiku'  // æ›´ä¾¿å®œçš„æ¨¡å‹
        }
    }
}
```

**è°ƒç”¨å­ Agent**ï¼š

```typescript
// AI ä¼šè‡ªåŠ¨è°ƒç”¨ agent å·¥å…·
"è¯·ä½¿ç”¨ code-reviewer agent å®¡æŸ¥è¿™ä¸ªæ–‡ä»¶"
```

### 8.7 é…ç½®æºæ§åˆ¶

å¯ä»¥æ§åˆ¶ä»å“ªäº›é…ç½®æºåŠ è½½è®¾ç½®ï¼š

```typescript
options: {
    settingSources: ['user', 'project', 'local']
    // ä¼˜å…ˆçº§ï¼šlocal > project > user
}
```

---

## 9. æˆæœ¬å’Œæ€§èƒ½è¿½è¸ª

### 9.1 Token ä½¿ç”¨ç»Ÿè®¡

SDK æä¾›è¯¦ç»†çš„ Token ä½¿ç”¨ç»Ÿè®¡ï¼š

```typescript
{
    usage: {
        input_tokens: 1500,           // è¾“å…¥ token
        output_tokens: 500,           // è¾“å‡º token
        cache_read_input_tokens: 200, // ç¼“å­˜å‘½ä¸­ token
        cache_creation_input_tokens: 100  // ç¼“å­˜åˆ›å»º token
    }
}
```

**Prompt Caching**ï¼š

- SDK è‡ªåŠ¨åˆ©ç”¨ Anthropic çš„ Prompt Caching åŠŸèƒ½
- `cache_read_input_tokens` å¯ä»¥æ˜¾è‘—é™ä½æˆæœ¬
- é•¿æœŸä¼šè¯å’Œé‡å¤ä»»åŠ¡å—ç›Šæœ€å¤§

### 9.2 æˆæœ¬è¿½è¸ª

æä¾›ç¾å…ƒæˆæœ¬ä¼°ç®—ï¼š

```typescript
{
    total_cost_usd: 0.0245,  // æ€»æˆæœ¬
    modelUsage: {
        'claude-3-5-sonnet-20241022': {
            inputTokens: 1500,
            outputTokens: 500,
            costUSD: 0.0200,
            webSearchRequests: 2
        },
        'claude-3-opus-20240229': {
            inputTokens: 300,
            outputTokens: 100,
            costUSD: 0.0045,
            webSearchRequests: 0
        }
    }
}
```

**å¤šæ¨¡å‹æ”¯æŒ**ï¼š

- å¯ä»¥åœ¨ä¸€ä¸ªä¼šè¯ä¸­ä½¿ç”¨å¤šä¸ªæ¨¡å‹
- æ¯ä¸ªæ¨¡å‹çš„æˆæœ¬å•ç‹¬ç»Ÿè®¡
- ä¾¿äºæˆæœ¬å½’å› å’Œä¼˜åŒ–

### 9.3 æ€§èƒ½æŒ‡æ ‡

æä¾›è¯¦ç»†çš„æ€§èƒ½æ•°æ®ï¼š

```typescript
{
    duration_ms: 15234,         // æ€»è€—æ—¶
    duration_api_ms: 12000,     // API è°ƒç”¨è€—æ—¶
    num_turns: 5                // å¯¹è¯è½®æ•°
}
```

**ä¼˜åŒ–å»ºè®®**ï¼š

- `duration_api_ms` å æ¯”è¿‡é«˜ï¼šè€ƒè™‘ä½¿ç”¨ç¼“å­˜æˆ–æ›´å¿«çš„æ¨¡å‹
- `num_turns` è¿‡å¤šï¼šä¼˜åŒ– prompt æé«˜æ•ˆç‡
- æ€»è€—æ—¶è¿‡é•¿ï¼šè€ƒè™‘å¹¶è¡ŒåŒ–æˆ–å¢åŠ è¶…æ—¶

---

## 10. é”™è¯¯å¤„ç†å’Œè°ƒè¯•

### 10.1 é”™è¯¯ç±»å‹

SDK å®šä¹‰äº†æ¸…æ™°çš„é”™è¯¯ç±»å‹ï¼š

#### AbortError
```typescript
class AbortError extends Error {}
```

**è§¦å‘åœºæ™¯**ï¼š

- ç”¨æˆ·è°ƒç”¨ `interrupt()`
- è®¾ç½®äº† `abortController` å¹¶è°ƒç”¨ `abort()`
- è¶…æ—¶

**å¤„ç†æ–¹å¼**ï¼š

```typescript
try {
    for await (const message of response) {
        // ...
    }
} catch (error) {
    if (error instanceof AbortError) {
        console.log('ä»»åŠ¡è¢«ä¸­æ–­');
    }
}
```

#### å…¶ä»–é”™è¯¯

- **é…ç½®é”™è¯¯**ï¼šoptions å‚æ•°ä¸åˆæ³•
- **API é”™è¯¯**ï¼šClaude API è°ƒç”¨å¤±è´¥
- **å·¥å…·é”™è¯¯**ï¼šå·¥å…·æ‰§è¡Œå¤±è´¥ï¼ˆä¼šé‡è¯•ï¼‰

### 10.2 è°ƒè¯•æ”¯æŒ

#### æ ‡å‡†é”™è¯¯è¾“å‡º

å¯ä»¥æ•è· stderr è¾“å‡ºï¼š

```typescript
options: {
    stderr: (data: string) => {
        console.error('[SDK]', data);
    }
}
```

**è¾“å‡ºå†…å®¹**ï¼š

- å·¥å…·æ‰§è¡Œæ—¥å¿—
- æƒé™æ£€æŸ¥ä¿¡æ¯
- MCP æœåŠ¡å™¨è¿æ¥çŠ¶æ€
- å†…éƒ¨é”™è¯¯å’Œè­¦å‘Š

#### ä¼šè¯è½¬å½•

æ¯ä¸ªä¼šè¯éƒ½ä¼šç”Ÿæˆ transcript æ–‡ä»¶ï¼š

- **ä½ç½®**ï¼š`~/.claude/transcripts/{session_id}/`
- **æ ¼å¼**ï¼šJSON Linesï¼ˆæ¯è¡Œä¸€ä¸ª JSON å¯¹è±¡ï¼‰
- **å†…å®¹**ï¼šå®Œæ•´çš„æ¶ˆæ¯å†å²

é€šè¿‡ `PreToolUse` ç­‰é’©å­å¯ä»¥è·å– `transcript_path`ï¼Œä¾¿äºè°ƒè¯•å’Œå®¡è®¡ã€‚

---

## 11. ä¸ Claude Code äº§å“çš„å…³ç³»

### 11.1 å…±äº«æ ¸å¿ƒ

SDK å’Œ Claude Code æ¡Œé¢åº”ç”¨/CLI/ç¼–è¾‘å™¨æ’ä»¶**å…±äº«ç›¸åŒçš„æ ¸å¿ƒå¼•æ“**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Claude Code Core Engine                 â”‚
â”‚  â€¢ Agent å¾ªç¯                                   â”‚
â”‚  â€¢ å·¥å…·æ‰§è¡Œ                                     â”‚
â”‚  â€¢ æƒé™ç³»ç»Ÿ                                     â”‚
â”‚  â€¢ MCP åè®®                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚         â”‚         â”‚             â”‚
    â”Œâ”€â”€â”€â–¼â”€â”€â”€â” â”Œâ”€â”€â–¼â”€â”€â”  â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
    â”‚  SDK  â”‚ â”‚ CLI â”‚  â”‚ VSCode â”‚  â”‚JetBrainsâ”‚
    â”‚       â”‚ â”‚     â”‚  â”‚ Plugin â”‚  â”‚  Plugin â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è¿™æ„å‘³ç€**ï¼š

- SDK çš„è¡Œä¸ºä¸ Claude Code æ¡Œé¢ç‰ˆå®Œå…¨ä¸€è‡´
- åœ¨ SDK ä¸­æµ‹è¯•çš„ Agent å¯ä»¥ç›´æ¥åœ¨ Claude Code ä¸­è¿è¡Œ
- å…±äº«é…ç½®æ–‡ä»¶ï¼ˆ.claude/ ç›®å½•ï¼‰

### 11.2 SDK ç‹¬æœ‰ç‰¹æ€§

ç›¸æ¯”æ¡Œé¢ç‰ˆï¼ŒSDK æä¾›äº†é¢å¤–çš„ç¼–ç¨‹èƒ½åŠ›ï¼š

1. **å®Œå…¨è‡ªåŠ¨åŒ–**ï¼šæ— éœ€äººå·¥äº¤äº’
2. **è‡ªå®šä¹‰é’©å­**ï¼šæ‹¦æˆªå’Œä¿®æ”¹ Agent è¡Œä¸º
3. **åµŒå…¥é›†æˆ**ï¼šä½œä¸ºåº“é›†æˆåˆ°ä»»æ„ Node.js åº”ç”¨
4. **æ‰¹é‡å¤„ç†**ï¼šå¹¶å‘è¿è¡Œå¤šä¸ª Agent ä¼šè¯
5. **CI/CD é›†æˆ**ï¼šåœ¨è‡ªåŠ¨åŒ–æµç¨‹ä¸­ä½¿ç”¨ AI

---

## 12. æœ€ä½³å®è·µ

### 12.1 æƒé™é…ç½®

**å¼€å‘ç¯å¢ƒ**ï¼š
```typescript
options: {
    permissionMode: 'default',  // ä¿æŒäº¤äº’
    allowedTools: ['file_read', 'grep', 'glob']  // åªè¯»å·¥å…·
}
```

**è‡ªåŠ¨åŒ–è„šæœ¬**ï¼š
```typescript
options: {
    permissionMode: 'bypassPermissions',  // å…¨è‡ªåŠ¨
    // ä½†é€šè¿‡ canUseTool å®ç°å…³é”®æ£€æŸ¥
    canUseTool: async (toolName, input) => {
        if (toolName === 'bash' && isDangerousCommand(input.command)) {
            return { behavior: 'deny', message: 'å±é™©å‘½ä»¤', interrupt: true };
        }
        return { behavior: 'allow', updatedInput: input };
    }
}
```

### 12.2 æˆæœ¬ä¼˜åŒ–

1. **ä½¿ç”¨ Prompt Caching**ï¼š
   - å°†ä¸å˜çš„ä¸Šä¸‹æ–‡ï¼ˆå¦‚ä»£ç åº“è¯´æ˜ï¼‰æ”¾åœ¨ system prompt
   - åˆ©ç”¨è‡ªåŠ¨ç¼“å­˜é™ä½æˆæœ¬

2. **é€‰æ‹©åˆé€‚çš„æ¨¡å‹**ï¼š
   - ç®€å•ä»»åŠ¡ï¼š`haiku`ï¼ˆæœ€ä¾¿å®œï¼‰
   - æ—¥å¸¸ç¼–ç¨‹ï¼š`sonnet`ï¼ˆæ€§ä»·æ¯”é«˜ï¼‰
   - å¤æ‚æ¨ç†ï¼š`opus`ï¼ˆæœ€å¼ºå¤§ï¼‰

3. **é™åˆ¶å¯¹è¯è½®æ•°**ï¼š
```typescript
options: {
    maxTurns: 10  // é˜²æ­¢æ— é™å¾ªç¯
}
```

### 12.3 é”™è¯¯æ¢å¤

å®ç°è‡ªåŠ¨é‡è¯•å’Œæ¢å¤ï¼š

```typescript
async function robustQuery(prompt: string, maxRetries = 3) {
    for (let i = 0; i < maxRetries; i++) {
        try {
            const response = query({ prompt, options });
            const result = await collectMessages(response);
            return result;
        } catch (error) {
            if (error instanceof AbortError) {
                throw error;  // ç”¨æˆ·ä¸­æ–­ï¼Œä¸é‡è¯•
            }
            if (i === maxRetries - 1) throw error;
            
            console.log(`é‡è¯• ${i + 1}/${maxRetries}...`);
            await sleep(1000 * (i + 1));  // æŒ‡æ•°é€€é¿
        }
    }
}
```

### 12.4 æ—¥å¿—å’Œç›‘æ§

é€šè¿‡é’©å­å®ç°å…¨é¢çš„æ—¥å¿—è®°å½•ï¼š

```typescript
options: {
    hooks: {
        PreToolUse: [{
            hooks: [async (input) => {
                logger.info('å·¥å…·è°ƒç”¨', {
                    tool: input.tool_name,
                    input: input.tool_input,
                    sessionId: input.session_id
                });
                return {};
            }]
        }],
        PostToolUse: [{
            hooks: [async (input) => {
                logger.info('å·¥å…·æ‰§è¡Œå®Œæˆ', {
                    tool: input.tool_name,
                    response: input.tool_response
                });
                return {};
            }]
        }],
        SessionEnd: [{
            hooks: [async (input) => {
                logger.info('ä¼šè¯ç»“æŸ', {
                    reason: input.reason,
                    sessionId: input.session_id
                });
                return {};
            }]
        }]
    }
}
```

---

## 13. å±€é™æ€§å’Œæ³¨æ„äº‹é¡¹

### 13.1 å¹³å°é™åˆ¶

- **Node.js 18+**ï¼šéœ€è¦ç°ä»£ Node.js ç‰ˆæœ¬
- **æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿ**ï¼šå·¥å…·åªèƒ½è®¿é—®æœ¬åœ°æ–‡ä»¶
- **ç½‘ç»œè®¿é—®**ï¼šéœ€è¦ç½‘ç»œè¿æ¥åˆ° Anthropic API

### 13.2 æ€§èƒ½è€ƒé‡

- **è¿›ç¨‹å¼€é”€**ï¼šæ¯æ¬¡è°ƒç”¨ `query()` éƒ½ä¼šå¯åŠ¨æ–°çš„ Claude Code è¿›ç¨‹
- **å†…å­˜ä½¿ç”¨**ï¼šé•¿ä¼šè¯ä¼šå ç”¨å¤§é‡å†…å­˜ï¼ˆå†å²æ¶ˆæ¯ç´¯ç§¯ï¼‰
- **å¹¶å‘é™åˆ¶**ï¼šå¹¶å‘ä¼šè¯æ•°å— API é€Ÿç‡é™åˆ¶

### 13.3 å®‰å…¨è€ƒè™‘

- **ä»£ç æ‰§è¡Œé£é™©**ï¼šbash å·¥å…·å¯ä»¥æ‰§è¡Œä»»æ„å‘½ä»¤
- **æ–‡ä»¶è®¿é—®**ï¼šfile_write å¯ä»¥ä¿®æ”¹ä»»æ„æ–‡ä»¶
- **API Key ä¿æŠ¤**ï¼šåŠ¡å¿…å¦¥å–„ä¿ç®¡ API Key

**å»ºè®®**ï¼š

- ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ `plan` æ¨¡å¼
- å®æ–½ä¸¥æ ¼çš„ `canUseTool` æ£€æŸ¥
- ä½¿ç”¨æƒé™è§„åˆ™é™åˆ¶å·¥å…·èƒ½åŠ›
- å®šæœŸå®¡è®¡ä¼šè¯è½¬å½•

---

## 14. æ€»ç»“

### 14.1 æ ¸å¿ƒä»·å€¼

`@anthropic-ai/claude-agent-sdk` çš„æ ¸å¿ƒä»·å€¼åœ¨äºï¼š

1. **é›¶å®ç°è´Ÿæ‹…**ï¼šæ‰€æœ‰å·¥å…·ç”± SDK è‡ªåŠ¨æ‰§è¡Œ
2. **ç”Ÿäº§çº§è´¨é‡**ï¼šä¸ Claude Code äº§å“å…±äº«æ ¸å¿ƒå¼•æ“
3. **æè‡´çµæ´»**ï¼šé€šè¿‡é’©å­å’Œæƒé™ç³»ç»Ÿå®Œå…¨å¯æ§
4. **ç®€æ´ API**ï¼šä»…ä¸€ä¸ª `query()` å‡½æ•°
5. **å¼€æ”¾æ‰©å±•**ï¼šé€šè¿‡ MCP åè®®è¿æ¥ä»»æ„å·¥å…·

### 14.2 é€‚ç”¨åœºæ™¯

**ç†æƒ³åœºæ™¯**ï¼š

- è‡ªåŠ¨åŒ–ä»£ç å®¡æŸ¥å’Œé‡æ„
- CI/CD ä¸­çš„æ™ºèƒ½ä¿®å¤
- æ‰¹é‡ä»£ç è¿ç§»å’Œå‡çº§
- æ–‡æ¡£ç”Ÿæˆå’Œç»´æŠ¤
- å¤æ‚çš„ä»£ç åˆ†æä»»åŠ¡

**ä¸é€‚åˆåœºæ™¯**ï¼š

- éœ€è¦äºšç§’çº§å“åº”çš„å®æ—¶åº”ç”¨
- é«˜åº¦å—é™çš„æ²™ç®±ç¯å¢ƒ
- ç¦»çº¿ç¯å¢ƒï¼ˆéœ€è¦ API è¿æ¥ï¼‰

### 14.3 æŠ€æœ¯äº®ç‚¹

1. **æµå¼æ¶æ„**ï¼šAsyncGenerator å®ç°é«˜æ•ˆçš„æµå¼é€šä¿¡
2. **æƒé™ç³»ç»Ÿ**ï¼šå¤šå±‚æ¬¡çš„å®‰å…¨æ§åˆ¶
3. **é’©å­æœºåˆ¶**ï¼šå¯ç¼–ç¨‹çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†
4. **MCP åè®®**ï¼šå¼€æ”¾çš„å·¥å…·æ‰©å±•æ ‡å‡†
5. **è‡ªåŠ¨ç¼“å­˜**ï¼šPrompt Caching è‡ªåŠ¨ä¼˜åŒ–æˆæœ¬

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0 (åŸºäº @anthropic-ai/claude-agent-sdk@0.1.5)

**æœ€åæ›´æ–°**: 2025-10-03

**ä½œè€…**: AI æ¶æ„åˆ†æ

**å‚è€ƒèµ„æ–™**:
- æœ¬åœ° SDK æºç åˆ†æ
- Anthropic å®˜æ–¹æ–‡æ¡£
- Claude Code äº§å“æ–‡æ¡£
- MCP åè®®è§„èŒƒ
