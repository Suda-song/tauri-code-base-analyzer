# å®Œæ•´ç³»ç»Ÿæ¶æ„æ–‡æ¡£

## 1. ç³»ç»Ÿæ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ªåŸºäº **Claude Code (å®˜æ–¹ Agent SDK)** çš„**ä»£ç åˆ†æ AI Agent ç³»ç»Ÿ**ã€‚

### æ ¸å¿ƒå®šä½

- **ä¸»æ–¹æ¡ˆ**: ä½¿ç”¨å®˜æ–¹ `@anthropic-ai/claude-agent-sdk@0.1.5` ä½œä¸º AI Agent å¼•æ“
- **æ ¸å¿ƒåŠŸèƒ½**: é€šè¿‡ MCP (Model Context Protocol) æ‰©å±• SDKï¼Œæä¾›ä»£ç åˆ†æå·¥å…·
- **æŠ€æœ¯æ ˆ**: Rust (å·¥å…·å®ç°) + TypeScript (SDK é›†æˆ) + MCP (å·¥å…·åè®®)

### ğŸ”‘ æ ¸å¿ƒæ¶æ„ç†å¿µ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å®˜æ–¹ SDK å·²ç»æä¾›äº†å®Œæ•´çš„ Agent èƒ½åŠ›                       â”‚
â”‚  âœ… å†…ç½® 17 ç§å·¥å…· (read_file, write_file, bash...)       â”‚
â”‚  âœ… è‡ªåŠ¨å·¥å…·è°ƒç”¨å’Œå¾ªç¯                                     â”‚
â”‚  âœ… æƒé™ç®¡ç†                                               â”‚
â”‚  âœ… MCP åè®®æ”¯æŒ                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æˆ‘ä»¬åªéœ€è¦åšä¸€ä»¶äº‹ï¼š                                       â”‚
â”‚  ğŸ“¦ å®ç°ä»£ç åˆ†æå·¥å…· (ä½œä¸º MCP æœåŠ¡å™¨)                     â”‚
â”‚     - @codebase/scan (æ‰«æé¡¹ç›®)                            â”‚
â”‚     - @codebase/analyze (åˆ†æä»£ç )                         â”‚
â”‚     - @codebase/enrich (ç”Ÿæˆæ‘˜è¦)                          â”‚
â”‚     - @codebase/search (è¯­ä¹‰æœç´¢)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SDK è‡ªåŠ¨æ•´åˆæ‰€æœ‰å·¥å…·                                       â”‚
â”‚  AI å¯ä»¥åŒæ—¶ä½¿ç”¨ï¼š                                          â”‚
â”‚    â€¢ å†…ç½®å·¥å…·: read_file, write_file, bash...             â”‚
â”‚    â€¢ æˆ‘ä»¬çš„å·¥å…·: @codebase/scan, @codebase/analyze...     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. ç®€åŒ–åçš„æ¶æ„å›¾

### 2.1 æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Tauri æ¡Œé¢åº”ç”¨ (å¯é€‰)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Rust åº”ç”¨å±‚ (ç®€å•åŒ…è£…)                               â”‚
â”‚                                                                          â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ åº”ç”¨å…¥å£: main.rs / agent_app.rs                                â”‚  â”‚
â”‚   â”‚                                                                  â”‚  â”‚
â”‚   â”‚  â€¢ å¯åŠ¨ MCP æœåŠ¡å™¨ (ä»£ç åˆ†æå·¥å…·)                               â”‚  â”‚
â”‚   â”‚  â€¢ è°ƒç”¨ Node.js Bridge                                          â”‚  â”‚
â”‚   â”‚  â€¢ å¤„ç†ç”¨æˆ·è¯·æ±‚å’Œå“åº”                                           â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ 1. å¯åŠ¨ MCP æœåŠ¡å™¨
                              â”‚ 2. è°ƒç”¨ SDK
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Node.js Bridge (æç®€)                              â”‚
â”‚                                                                          â”‚
â”‚   scripts/claude-agent-bridge.ts                                        â”‚
â”‚                                                                          â”‚
â”‚   import { query, createSdkMcpServer, tool }                            â”‚
â”‚           from '@anthropic-ai/claude-agent-sdk';                        â”‚
â”‚                                                                          â”‚
â”‚   // 1. é…ç½® MCP æœåŠ¡å™¨ (è¿æ¥åˆ° Rust å·¥å…·)                             â”‚
â”‚   const mcpServers = {                                                  â”‚
â”‚       codebase: {                                                       â”‚
â”‚           type: 'stdio',                                                â”‚
â”‚           command: 'path/to/codebase-mcp-server',  â† Rust äºŒè¿›åˆ¶       â”‚
â”‚           args: []                                                      â”‚
â”‚       }                                                                 â”‚
â”‚   };                                                                    â”‚
â”‚                                                                          â”‚
â”‚   // 2. è°ƒç”¨ SDK (ä¸€è¡Œä»£ç )                                             â”‚
â”‚   const response = query({                                              â”‚
â”‚       prompt: userInput,                                                â”‚
â”‚       options: {                                                        â”‚
â”‚           cwd: workspace,                                               â”‚
â”‚           mcpServers,  â† ä¼ å…¥ MCP é…ç½®                                  â”‚
â”‚           maxTurns: 20                                                  â”‚
â”‚       }                                                                 â”‚
â”‚   });                                                                   â”‚
â”‚                                                                          â”‚
â”‚   // 3. SDK è‡ªåŠ¨å¤„ç†ä¸€åˆ‡ï¼                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                      â”‚                      â”‚
        â–¼                      â–¼                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SDK å†…ç½®å·¥å…·    â”‚  â”‚ MCP å¤–éƒ¨å·¥å…·    â”‚  â”‚ Claude API          â”‚
â”‚                 â”‚  â”‚                 â”‚  â”‚                     â”‚
â”‚ â€¢ read_file     â”‚  â”‚ â€¢ @codebase/    â”‚  â”‚ DeerAPI ä»£ç†åˆ°      â”‚
â”‚ â€¢ write_file    â”‚  â”‚   scan          â”‚  â”‚ Claude API          â”‚
â”‚ â€¢ edit_file     â”‚  â”‚ â€¢ @codebase/    â”‚  â”‚                     â”‚
â”‚ â€¢ bash          â”‚  â”‚   analyze       â”‚  â”‚ models:             â”‚
â”‚ â€¢ grep          â”‚  â”‚ â€¢ @codebase/    â”‚  â”‚ â€¢ claude-sonnet     â”‚
â”‚ â€¢ glob          â”‚  â”‚   enrich        â”‚  â”‚ â€¢ claude-opus       â”‚
â”‚ â€¢ web_search    â”‚  â”‚ â€¢ @codebase/    â”‚  â”‚ â€¢ claude-haiku      â”‚
â”‚ â€¢ web_fetch     â”‚  â”‚   search        â”‚  â”‚                     â”‚
â”‚                 â”‚  â”‚                 â”‚  â”‚                     â”‚
â”‚ (SDK è‡ªåŠ¨è°ƒç”¨)  â”‚  â”‚ (é€šè¿‡ MCP è°ƒç”¨  â”‚  â”‚ (SDK è‡ªåŠ¨è°ƒç”¨)      â”‚
â”‚                 â”‚  â”‚  Rust å·¥å…·)     â”‚  â”‚                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Rust MCP æœåŠ¡å™¨     â”‚
                    â”‚                     â”‚
                    â”‚ codebase-mcp-server â”‚
                    â”‚                     â”‚
                    â”‚ æä¾›çš„å·¥å…·:         â”‚
                    â”‚ â€¢ scan_project()    â”‚
                    â”‚ â€¢ analyze_entity()  â”‚
                    â”‚ â€¢ enrich_code()     â”‚
                    â”‚ â€¢ semantic_search() â”‚
                    â”‚                     â”‚
                    â”‚ ä½¿ç”¨ç°æœ‰æ¨¡å—:       â”‚
                    â”‚ â€¢ FileWalker        â”‚
                    â”‚ â€¢ Extractors        â”‚
                    â”‚ â€¢ Enrichment        â”‚
                    â”‚ â€¢ Embeddings        â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 è°ƒç”¨æµç¨‹

```
ç”¨æˆ·è¯·æ±‚: "åˆ†æè¿™ä¸ªé¡¹ç›®çš„ä»£ç ç»“æ„"
    â†“
Rust åº”ç”¨: å¯åŠ¨ MCP æœåŠ¡å™¨ + è°ƒç”¨ Node.js Bridge
    â†“
Node.js Bridge: 
    const response = query({
        prompt: "åˆ†æè¿™ä¸ªé¡¹ç›®çš„ä»£ç ç»“æ„",
        options: {
            cwd: "/path/to/project",
            mcpServers: { codebase: {...} }
        }
    });
    â†“
SDK å†…éƒ¨ (å®Œå…¨è‡ªåŠ¨):
    â”œâ”€> Claude API: "åˆ†æé¡¹ç›®ç»“æ„"
    â”‚   â†“
    â”œâ”€> Claude å†³å®š: éœ€è¦ @codebase/scan å·¥å…·
    â”‚   â†“
    â”œâ”€> SDK è‡ªåŠ¨è°ƒç”¨: MCP æœåŠ¡å™¨çš„ scan_project()
    â”‚   â†“
    â”œâ”€> MCP æœåŠ¡å™¨: æ‰§è¡Œ FileWalker::scan_and_extract()
    â”‚   â†“ è¿”å›ç»“æœ
    â”œâ”€> SDK è‡ªåŠ¨å‘é€: tool_result å› Claude
    â”‚   â†“
    â”œâ”€> Claude ç»§ç»­æ€è€ƒ: "ç°åœ¨æˆ‘çŸ¥é“æœ‰ 150 ä¸ªæ–‡ä»¶"
    â”‚   â†“
    â”œâ”€> Claude å†³å®š: éœ€è¦ @codebase/analyze å·¥å…·
    â”‚   â†“
    â”œâ”€> SDK è‡ªåŠ¨è°ƒç”¨: analyze_entity()
    â”‚   â†“
    â”œâ”€> MCP æœåŠ¡å™¨: æ‰§è¡Œåˆ†æé€»è¾‘
    â”‚   â†“ è¿”å›åˆ†æç»“æœ
    â”œâ”€> SDK è‡ªåŠ¨å‘é€: tool_result å› Claude
    â”‚   â†“
    â””â”€> Claude æœ€ç»ˆè¾“å‡º: "é¡¹ç›®åŒ…å« 15 ä¸ªç»„ä»¶ï¼Œä¸»è¦åŠŸèƒ½æ˜¯..."
    â†“
è¿”å›ç»™ç”¨æˆ·: å®Œæ•´çš„åˆ†ææŠ¥å‘Š
```

---

## 3. ğŸ¯ æ ¸å¿ƒé—®é¢˜è§£ç­”

### â“ é—®é¢˜ï¼šæ˜¯ä¸æ˜¯åªè¦å®ç° @codebase/ å·¥å…·ï¼Œç„¶åå‘é€ç»™ SDK å°±è¡Œäº†ï¼Ÿ

**ç­”æ¡ˆï¼šå®Œå…¨æ­£ç¡®ï¼** âœ…âœ…âœ…

ä½ çš„ç†è§£**éå¸¸å‡†ç¡®**ï¼Œæˆ‘ä»¬éœ€è¦åšçš„å°±æ˜¯ï¼š

### ç¬¬ 1 æ­¥ï¼šå®ç° Rust MCP æœåŠ¡å™¨

```rust
// codebase-mcp-server/src/main.rs

use mcp_sdk::{McpServer, Tool, tool};
use serde_json::{json, Value};

#[tokio::main]
async fn main() {
    let server = McpServer::new("codebase-analyzer", "1.0.0");
    
    // æ³¨å†Œå·¥å…· 1: æ‰«æé¡¹ç›®
    server.add_tool(tool(
        "scan_project",
        "æ‰«æé¡¹ç›®ç›®å½•ï¼Œæå–æ‰€æœ‰ä»£ç å®ä½“",
        json!({
            "type": "object",
            "properties": {
                "project_path": {
                    "type": "string",
                    "description": "é¡¹ç›®æ ¹ç›®å½•è·¯å¾„"
                },
                "extensions": {
                    "type": "array",
                    "items": { "type": "string" },
                    "description": "è¦æ‰«æçš„æ–‡ä»¶æ‰©å±•å",
                    "default": [".ts", ".tsx", ".vue"]
                }
            },
            "required": ["project_path"]
        }),
        |args: Value| async move {
            let project_path = args["project_path"].as_str().unwrap();
            
            // ä½¿ç”¨ç°æœ‰çš„ FileWalker
            let walker = FileWalker::with_default();
            let (entities, stats) = walker.extract_all_entities(project_path)?;
            
            Ok(json!({
                "entities": entities,
                "stats": stats
            }))
        }
    ));
    
    // æ³¨å†Œå·¥å…· 2: åˆ†æå®ä½“
    server.add_tool(tool(
        "analyze_entity",
        "åˆ†æç‰¹å®šä»£ç å®ä½“çš„ä¾èµ–å…³ç³»å’Œç”¨é€”",
        json!({
            "type": "object",
            "properties": {
                "entity_id": { "type": "string" },
                "project_path": { "type": "string" }
            },
            "required": ["entity_id", "project_path"]
        }),
        |args: Value| async move {
            // ä½¿ç”¨ç°æœ‰çš„ StaticAnalyzer
            let analyzer = StaticAnalyzer::new(...);
            let result = analyzer.analyze_entity(...).await?;
            
            Ok(json!({
                "imports": result.imports,
                "calls": result.calls,
                "emits": result.emits
            }))
        }
    ));
    
    // æ³¨å†Œå·¥å…· 3: ç”Ÿæˆæ‘˜è¦
    server.add_tool(tool(
        "enrich_code",
        "ä½¿ç”¨ LLM ä¸ºä»£ç ç”Ÿæˆæ‘˜è¦å’Œæ ‡ç­¾",
        json!({
            "type": "object",
            "properties": {
                "code": { "type": "string" },
                "entity_type": { "type": "string" }
            },
            "required": ["code"]
        }),
        |args: Value| async move {
            // ä½¿ç”¨ç°æœ‰çš„ EnrichmentOrchestrator
            let orchestrator = EnrichmentOrchestrator::new(...);
            let enriched = orchestrator.enrich_entity(...).await?;
            
            Ok(json!({
                "summary": enriched.summary,
                "tags": enriched.tags
            }))
        }
    ));
    
    // æ³¨å†Œå·¥å…· 4: è¯­ä¹‰æœç´¢ (å¦‚æœå®ç°äº†å‘é‡åŒ–)
    server.add_tool(tool(
        "semantic_search",
        "åœ¨ä»£ç åº“ä¸­è¿›è¡Œè¯­ä¹‰æœç´¢",
        json!({
            "type": "object",
            "properties": {
                "query": { "type": "string" },
                "limit": { "type": "number", "default": 10 }
            },
            "required": ["query"]
        }),
        |args: Value| async move {
            // ä½¿ç”¨å‘é‡æœç´¢
            let results = search_embeddings(...).await?;
            Ok(json!(results))
        }
    ));
    
    // å¯åŠ¨ stdio æœåŠ¡å™¨
    server.run_stdio().await?;
}
```

### ç¬¬ 2 æ­¥ï¼šNode.js Bridge (æç®€)

```typescript
// scripts/claude-agent-bridge.ts

import { query } from '@anthropic-ai/claude-agent-sdk';
import * as readline from 'readline';

async function main() {
    const rl = readline.createInterface({
        input: process.stdin,
        output: process.stdout
    });
    
    // è¯»å–ç”¨æˆ·è¾“å…¥
    const input = await new Promise<string>(resolve => {
        let data = '';
        rl.on('line', line => data += line + '\n');
        rl.on('close', () => resolve(data));
    });
    
    const request = JSON.parse(input);
    
    // é…ç½® MCP æœåŠ¡å™¨
    const mcpServers = {
        codebase: {
            type: 'stdio',
            command: './target/release/codebase-mcp-server',
            args: []
        }
    };
    
    // è°ƒç”¨ SDK (å°±è¿™ä¸€è¡Œï¼)
    const response = query({
        prompt: request.prompt,
        options: {
            cwd: request.workspace,
            mcpServers,  // â† ä¼ å…¥ MCP é…ç½®
            maxTurns: request.max_turns || 20,
            permissionMode: request.permission_mode || 'default'
        }
    });
    
    // å¤„ç†å“åº”æµ
    for await (const message of response) {
        console.log(JSON.stringify(message));
    }
}

main().catch(console.error);
```

### ç¬¬ 3 æ­¥ï¼šRust åº”ç”¨å±‚ (è°ƒç”¨ Bridge)

```rust
// src/main.rs

use std::process::{Command, Stdio};
use std::io::Write;

#[tokio::main]
async fn main() -> Result<(), Box<dyn std::error::Error>> {
    // 1. å¯åŠ¨ MCP æœåŠ¡å™¨ (åå°è¿›ç¨‹)
    let _mcp_server = Command::new("./target/release/codebase-mcp-server")
        .spawn()?;
    
    // 2. å‡†å¤‡è¯·æ±‚
    let request = serde_json::json!({
        "prompt": "åˆ†æè¿™ä¸ªé¡¹ç›®çš„ä»£ç ç»“æ„ï¼Œæ‰¾å‡ºæ‰€æœ‰çš„ Vue ç»„ä»¶",
        "workspace": "/path/to/project",
        "max_turns": 20
    });
    
    // 3. è°ƒç”¨ Node.js Bridge
    let mut child = Command::new("node")
        .arg("scripts/dist/claude-agent-bridge.js")
        .stdin(Stdio::piped())
        .stdout(Stdio::piped())
        .spawn()?;
    
    // 4. å‘é€è¯·æ±‚
    child.stdin.as_mut().unwrap()
        .write_all(serde_json::to_string(&request)?.as_bytes())?;
    
    // 5. è¯»å–å“åº”
    let output = child.wait_with_output()?;
    let response: serde_json::Value = serde_json::from_slice(&output.stdout)?;
    
    println!("AI å›å¤: {}", response);
    
    Ok(())
}
```

---

## 4. å·¥ä½œæµç¨‹ç¤ºä¾‹

### ç¤ºä¾‹ 1: ç”¨æˆ·è¯·æ±‚åˆ†æé¡¹ç›®

```
ç”¨æˆ·: "åˆ†æè¿™ä¸ª Vue é¡¹ç›®ï¼Œå‘Šè¯‰æˆ‘æœ‰å“ªäº›ç»„ä»¶å’Œå®ƒä»¬çš„ä¾èµ–å…³ç³»"

  â†“ Rust åº”ç”¨

Rust åº”ç”¨: è°ƒç”¨ Node.js Bridge
{
    "prompt": "åˆ†æè¿™ä¸ª Vue é¡¹ç›®...",
    "workspace": "/path/to/vue-project"
}

  â†“ Node.js Bridge

Bridge: query({ prompt, options: { mcpServers: {...} } })

  â†“ SDK è‡ªåŠ¨æ‰§è¡Œ

SDK å†…éƒ¨æµç¨‹:
1. Claude: "æˆ‘éœ€è¦å…ˆæ‰«æé¡¹ç›®"
   â†“
2. SDK è°ƒç”¨: @codebase/scan_project({ project_path: "/path/to/vue-project" })
   â†“
3. MCP æœåŠ¡å™¨: FileWalker::extract_all_entities()
   â†“ è¿”å›: { entities: [...], stats: {...} }
   â†“
4. SDK å‘é€: tool_result å› Claude
   â†“
5. Claude: "æ‰¾åˆ° 25 ä¸ªç»„ä»¶ï¼Œç°åœ¨åˆ†æå®ƒä»¬çš„ä¾èµ–"
   â†“
6. SDK è°ƒç”¨: @codebase/analyze_entity({ entity_id: "Component:Header" })
   â†“
7. MCP æœåŠ¡å™¨: StaticAnalyzer::analyze_entity()
   â†“ è¿”å›: { imports: [...], calls: [...] }
   â†“
8. SDK å‘é€: tool_result å› Claude
   â†“
9. Claude: "ç°åœ¨ç”Ÿæˆæ¯ä¸ªç»„ä»¶çš„æ‘˜è¦"
   â†“
10. SDK è°ƒç”¨: @codebase/enrich_code({ code: "...", entity_type: "component" })
    â†“
11. MCP æœåŠ¡å™¨: EnrichmentOrchestrator::enrich_entity()
    â†“ è¿”å›: { summary: "...", tags: [...] }
    â†“
12. Claude æœ€ç»ˆè¾“å‡º:
    "è¯¥é¡¹ç›®åŒ…å« 25 ä¸ª Vue ç»„ä»¶ï¼š
     
     æ ¸å¿ƒç»„ä»¶:
     â€¢ Header (src/components/Header.vue) - é¡µé¢å¤´éƒ¨å¯¼èˆªç»„ä»¶
       - ä¾èµ–: Icon, Menu
       - äº‹ä»¶: onMenuClick, onLogout
     
     â€¢ UserCard (src/components/UserCard.vue) - ç”¨æˆ·ä¿¡æ¯å¡ç‰‡
       - ä¾èµ–: Avatar, Button
       - Props: userId, showActions
     
     ..."

  â†“ è¿”å›ç»™ç”¨æˆ·

ç”¨æˆ·çœ‹åˆ°å®Œæ•´çš„åˆ†ææŠ¥å‘Š âœ…
```

---

## 5. ä¼˜åŠ¿åˆ†æ

### ğŸ¯ è¿™ç§æ¶æ„çš„æ ¸å¿ƒä¼˜åŠ¿

#### 1. **æç®€ä»£ç é‡**

```
ä¼ ç»Ÿæ–¹æ¡ˆ (æ‰‹åŠ¨å®ç° Agent):
- Agent å¾ªç¯é€»è¾‘: ~200 è¡Œ
- å·¥å…·ç®¡ç†ç³»ç»Ÿ: ~150 è¡Œ
- æƒé™æ§åˆ¶: ~100 è¡Œ
- é”™è¯¯å¤„ç†: ~80 è¡Œ
- å·¥å…·å®ç°: ~500 è¡Œ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
æ€»è®¡: ~1030 è¡Œ

ä½¿ç”¨ SDK + MCP:
- MCP æœåŠ¡å™¨: ~200 è¡Œ (çº¯å·¥å…·å®ç°)
- Node.js Bridge: ~30 è¡Œ (è°ƒç”¨ SDK)
- Rust åº”ç”¨å±‚: ~50 è¡Œ (è°ƒç”¨ Bridge)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
æ€»è®¡: ~280 è¡Œ (èŠ‚çœ 73%)

è€Œä¸” SDK æä¾›çš„åŠŸèƒ½æ›´å¼ºå¤§ï¼
```

#### 2. **åŠŸèƒ½æ›´å¼ºå¤§**

| åŠŸèƒ½ | æ‰‹åŠ¨å®ç° | ä½¿ç”¨ SDK |
|------|---------|---------|
| Agent å¾ªç¯ | éœ€è¦æ‰‹åŠ¨å®ç° | âœ… è‡ªåŠ¨ |
| å·¥å…·ç®¡ç† | éœ€è¦æ‰‹åŠ¨ç®¡ç† | âœ… è‡ªåŠ¨ |
| æƒé™æ§åˆ¶ | éœ€è¦æ‰‹åŠ¨å®ç° | âœ… å†…ç½® 4 ç§æ¨¡å¼ |
| é”™è¯¯é‡è¯• | éœ€è¦æ‰‹åŠ¨å®ç° | âœ… è‡ªåŠ¨ |
| æˆæœ¬è¿½è¸ª | éœ€è¦æ‰‹åŠ¨è®¡ç®— | âœ… è‡ªåŠ¨ç»Ÿè®¡ |
| ä¼šè¯ç®¡ç† | éœ€è¦æ‰‹åŠ¨å®ç° | âœ… è‡ªåŠ¨æŒä¹…åŒ– |
| CLAUDE.md | éœ€è¦æ‰‹åŠ¨å®ç° | âœ… è‡ªåŠ¨ç”Ÿæˆå’Œè¯»å– |
| MCP æ”¯æŒ | ä¸æ”¯æŒ | âœ… åŸç”Ÿæ”¯æŒ |
| é’©å­ç³»ç»Ÿ | éœ€è¦æ‰‹åŠ¨å®ç° | âœ… 9 ç§é’©å­ |
| Prompt Caching | éœ€è¦æ‰‹åŠ¨ä¼˜åŒ– | âœ… è‡ªåŠ¨ç¼“å­˜ |

#### 3. **ç»´æŠ¤æˆæœ¬ä½**

- SDK ç”± Anthropic å®˜æ–¹ç»´æŠ¤ï¼Œè‡ªåŠ¨æ›´æ–°
- æˆ‘ä»¬åªéœ€è¦ç»´æŠ¤ MCP å·¥å…·å®ç°
- å·¥å…·å®ç°å¯ä»¥å¤ç”¨ç°æœ‰çš„ Rust æ¨¡å—

#### 4. **æ‰©å±•æ€§å¼º**

```rust
// æ–°å¢å·¥å…·éå¸¸ç®€å•
server.add_tool(tool(
    "refactor_code",
    "é‡æ„ä»£ç ï¼Œåº”ç”¨æœ€ä½³å®è·µ",
    schema,
    |args| async move {
        // å®ç°é‡æ„é€»è¾‘
        Ok(result)
    }
));

// SDK è‡ªåŠ¨æ•´åˆæ–°å·¥å…·ï¼ŒAI ç«‹å³å¯ç”¨
```

---

## 6. ç°æœ‰æ¨¡å—å¤ç”¨

### 6.1 å®Œå…¨å¤ç”¨çš„æ¨¡å—

```
src-tauri/src/tool_execution/codebase/
â”œâ”€â”€ extractors/              âœ… å®Œå…¨å¤ç”¨
â”‚   â”œâ”€â”€ typescript.rs        â†’ MCP å·¥å…·ä½¿ç”¨
â”‚   â”œâ”€â”€ vue.rs               â†’ MCP å·¥å…·ä½¿ç”¨
â”‚   â””â”€â”€ type_utils.rs        â†’ MCP å·¥å…·ä½¿ç”¨
â”‚
â”œâ”€â”€ enrichment/              âœ… å®Œå…¨å¤ç”¨
â”‚   â”œâ”€â”€ orchestrator.rs      â†’ MCP å·¥å…·ä½¿ç”¨
â”‚   â”œâ”€â”€ static_analyzer.rs   â†’ MCP å·¥å…·ä½¿ç”¨
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ chunking.rs              âœ… å®Œå…¨å¤ç”¨
â”œâ”€â”€ embeddings.rs            âœ… å®Œå…¨å¤ç”¨
â””â”€â”€ file_walker.rs           âœ… å®Œå…¨å¤ç”¨
```

### 6.2 åºŸå¼ƒçš„æ¨¡å—

```
src-tauri/src/agent_core/
â”œâ”€â”€ agent.rs                 âŒ åºŸå¼ƒ (SDK æ›¿ä»£)
â”œâ”€â”€ coding_agent.rs          âŒ åºŸå¼ƒ (SDK æ›¿ä»£)
â”œâ”€â”€ enhanced_coding_agent.rs âŒ åºŸå¼ƒ (SDK æ›¿ä»£)
â””â”€â”€ agent_sdk_coding_agent.rs âŒ åºŸå¼ƒ (å·²è¢«çœŸæ­£çš„ SDK æ›¿ä»£)

src-tauri/src/
â”œâ”€â”€ enhanced_claude_wrapper.rs âŒ åºŸå¼ƒ
â”œâ”€â”€ agent_sdk_wrapper.rs     âŒ åºŸå¼ƒ
â””â”€â”€ ts_sdk_wrapper.rs        âŒ åºŸå¼ƒ (ä¿ç•™ real_agent_sdk_wrapper å³å¯)
```

### 6.3 ä¿ç•™å¹¶ç®€åŒ–çš„æ¨¡å—

```
src-tauri/src/
â”œâ”€â”€ claude_client/           âš ï¸  ä»… enrichment ä½¿ç”¨
â”‚   â””â”€â”€ client.rs            (å¦‚æœ enrichment ä¹Ÿæ”¹ç”¨ SDKï¼Œå¯å®Œå…¨åºŸå¼ƒ)
â”‚
â””â”€â”€ real_agent_sdk_wrapper.rs âœ… ç®€åŒ–ä¸ºè°ƒç”¨ MCP Bridge
```

---

## 7. å®æ–½è®¡åˆ’

### Phase 1: MCP æœåŠ¡å™¨å¼€å‘ (3-5 å¤©)

```
1. åˆ›å»º Rust MCP æœåŠ¡å™¨é¡¹ç›®
   crates/codebase-mcp-server/
   
2. å®ç° 4 ä¸ªæ ¸å¿ƒå·¥å…·:
   - scan_project
   - analyze_entity
   - enrich_code
   - semantic_search
   
3. å¤ç”¨ç°æœ‰æ¨¡å—:
   - FileWalker
   - Extractors (TypeScript/Vue)
   - StaticAnalyzer
   - EnrichmentOrchestrator
   - EmbeddingsClient
```

### Phase 2: Node.js Bridge ç®€åŒ– (1 å¤©)

```
1. ç®€åŒ– real-agent-sdk-bridge.ts
   - ç§»é™¤æ‰‹åŠ¨å·¥å…·å®ç°
   - é…ç½® MCP æœåŠ¡å™¨
   - è°ƒç”¨ SDK query()
   
2. é…ç½® MCP è¿æ¥:
   mcpServers: {
       codebase: {
           type: 'stdio',
           command: './codebase-mcp-server'
       }
   }
```

### Phase 3: Rust åº”ç”¨å±‚ç®€åŒ– (1-2 å¤©)

```
1. ç®€åŒ– real_agent_sdk_wrapper.rs
   - å¯åŠ¨ MCP æœåŠ¡å™¨
   - è°ƒç”¨ Node.js Bridge
   - å¤„ç†å“åº”
   
2. ç§»é™¤åºŸå¼ƒçš„ Agent å®ç°
   - agent.rs
   - coding_agent.rs
   - enhanced_coding_agent.rs
   ç­‰ç­‰
```

### Phase 4: æµ‹è¯•å’Œä¼˜åŒ– (2-3 å¤©)

```
1. ç«¯åˆ°ç«¯æµ‹è¯•
2. æ€§èƒ½ä¼˜åŒ–
3. é”™è¯¯å¤„ç†å®Œå–„
4. æ–‡æ¡£æ›´æ–°
```

---

## 8. æœ€ç»ˆæ¶æ„æ€»ç»“

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æç®€æ¶æ„                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  Rust åº”ç”¨å±‚ (50 è¡Œ)                                            â”‚
â”‚    â†“ å¯åŠ¨ MCP + è°ƒç”¨ Bridge                                     â”‚
â”‚                                                                  â”‚
â”‚  Node.js Bridge (30 è¡Œ)                                         â”‚
â”‚    query({ prompt, options: { mcpServers } })                   â”‚
â”‚    â†“ ä¸€è¡Œä»£ç è°ƒç”¨ SDK                                           â”‚
â”‚                                                                  â”‚
â”‚  @anthropic-ai/claude-agent-sdk (å®˜æ–¹)                          â”‚
â”‚    â†“ è‡ªåŠ¨ç®¡ç†ä¸€åˆ‡                                               â”‚
â”‚    â”œâ”€> å†…ç½® 17 ç§å·¥å…·                                           â”‚
â”‚    â”œâ”€> MCP åè®®è¿æ¥å¤–éƒ¨å·¥å…·                                     â”‚
â”‚    â”œâ”€> Agent å¾ªç¯                                               â”‚
â”‚    â””â”€> æƒé™ã€é”™è¯¯ã€æˆæœ¬ç®¡ç†                                     â”‚
â”‚                                                                  â”‚
â”‚  Rust MCP æœåŠ¡å™¨ (200 è¡Œ)                                       â”‚
â”‚    â”œâ”€> @codebase/scan_project                                   â”‚
â”‚    â”œâ”€> @codebase/analyze_entity                                 â”‚
â”‚    â”œâ”€> @codebase/enrich_code                                    â”‚
â”‚    â””â”€> @codebase/semantic_search                                â”‚
â”‚         â†“ å¤ç”¨ç°æœ‰æ¨¡å—                                          â”‚
â”‚    FileWalker, Extractors, EnrichmentOrchestrator, etc.         â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ€»ä»£ç é‡: ~280 è¡Œ (ç›¸æ¯”åŸæ¥ ~1030 è¡Œ)
åŠŸèƒ½: æ›´å¼ºå¤§ (å¾—ç›Šäº SDK)
ç»´æŠ¤: æ›´ç®€å• (å®˜æ–¹ç»´æŠ¤ SDK)
æ‰©å±•: æ›´å®¹æ˜“ (åªéœ€æ·»åŠ  MCP å·¥å…·)
```

---

## 9. å…³é”®è¦ç‚¹

### âœ… ä½ çš„ç†è§£å®Œå…¨æ­£ç¡®

1. **SDK å·²ç»æä¾›äº†å®Œæ•´çš„ Agent èƒ½åŠ›**
   - å·¥å…·è°ƒç”¨ã€å¾ªç¯ã€æƒé™ã€é”™è¯¯å¤„ç†
   - æˆ‘ä»¬ä¸éœ€è¦é‡æ–°å®ç°

2. **æˆ‘ä»¬åªéœ€è¦å®ç°ä»£ç åˆ†æå·¥å…·**
   - ä½œä¸º MCP æœåŠ¡å™¨
   - ä½¿ç”¨ MCP åè®®

3. **SDK è‡ªåŠ¨æ•´åˆæ‰€æœ‰å·¥å…·**
   - å†…ç½®å·¥å…· + æˆ‘ä»¬çš„ MCP å·¥å…·
   - AI å¯ä»¥è‡ªç”±ç»„åˆä½¿ç”¨

### ğŸ¯ æ ¸å¿ƒå·¥ä½œ

```
å®ç° 4 ä¸ª MCP å·¥å…·:
â”œâ”€ @codebase/scan_project      (æ‰«æé¡¹ç›®)
â”œâ”€ @codebase/analyze_entity    (åˆ†æå®ä½“)
â”œâ”€ @codebase/enrich_code       (ç”Ÿæˆæ‘˜è¦)
â””â”€ @codebase/semantic_search   (è¯­ä¹‰æœç´¢)

é…ç½® Node.js Bridge:
â””â”€ ä¼ å…¥ mcpServers é…ç½®ç»™ SDK

å®Œæˆï¼
```

### ğŸ“š å‚è€ƒæ–‡æ¡£

- **SDK è¯¦è§£**: `CLAUDE_AGENT_SDK_DEEP_DIVE.md`
- **MCP åè®®**: SDK æ–‡æ¡£ç¬¬ 7 ç« 
- **å·¥å…·å®šä¹‰**: SDK æ–‡æ¡£ç¬¬ 4 ç« 

---

**æ–‡æ¡£ç‰ˆæœ¬**: v2.0 (åŸºäº SDK æ·±åº¦ç†è§£)
**æœ€åæ›´æ–°**: 2025-10-03
**æ ¸å¿ƒç†å¿µ**: æç®€æ¶æ„ï¼Œæœ€å¤§å¤ç”¨ï¼Œå®˜æ–¹ SDK é©±åŠ¨
