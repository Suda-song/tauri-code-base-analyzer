# 🏗️ cursor-mcp-plugin 架构重构说明

## 📁 新的目录结构

```
src/
├── config/
│   └── server-config.ts          # 服务器配置和类型定义
├── tools/
│   ├── handlers/                 # 工具处理器
│   │   ├── base-handler.ts       # 基础处理器类
│   │   ├── start-analysis-handler.ts      # 开始分析处理器
│   │   ├── core-component-handler.ts      # 核心组件选择处理器  
│   │   ├── modify-entity-handler.ts       # 实体修改处理器
│   │   ├── generate-prompt-handler.ts     # 代码生成处理器
│   │   └── quick-analysis-handler.ts      # 快速分析处理器
│   ├── tool-registry.ts          # 工具注册器
│   └── params.ts                 # 工具参数定义 (保留)
├── utils/
│   ├── entity-utils.ts           # 实体转换工具函数
│   ├── prompt-generator.ts       # 代码提示词生成函数
│   └── search-utils.ts           # 搜索相关工具函数 (保留)
├── services/
│   └── conversation-service.ts   # 会话状态管理 (保留)
├── types/
│   └── index.ts                  # 类型定义 (保留)
├── index-refactored.ts           # 重构后的主文件
└── index.ts                      # 原始主文件 (可删除)
```

## 🎯 重构目标与成果

### 问题
- 原 `index.ts` 文件 687 行，过于庞大
- 所有工具逻辑混杂在一个文件中
- 缺乏清晰的模块边界
- 难以维护和扩展

### 解决方案
- **模块化拆分**: 按功能将代码拆分为独立模块
- **职责分离**: 每个模块专注于特定职责
- **统一架构**: 使用基类和注册器模式
- **清晰接口**: 定义明确的模块间接口

## 📚 核心模块说明

### 1. 配置模块 (`config/`)
- `server-config.ts`: 统一管理服务器配置、类型扩展和触发条件

### 2. 工具处理器 (`tools/handlers/`)
- `BaseHandler`: 所有处理器的基类，提供通用功能
- 每个工具一个独立的处理器类，职责单一
- 统一的错误处理和实体文件检查

### 3. 工具注册器 (`tools/tool-registry.ts`)
- 统一管理所有工具的注册
- 集中处理工具调用分发
- 简化主文件的复杂度

### 4. 工具函数 (`utils/`)
- `entity-utils.ts`: 实体类型转换
- `prompt-generator.ts`: 代码提示词生成
- 可复用的纯函数，易于测试

### 5. 主服务器类 (`index-refactored.ts`)
- 简洁的主文件，只负责服务器启动
- 使用依赖注入和模块组合
- 清晰的程序入口点

## 🔄 使用新架构

### 替换原文件
1. 将 `index.ts` 重命名为 `index.old.ts`
2. 将 `index-refactored.ts` 重命名为 `index.ts`
3. 测试功能是否正常

### 扩展新功能
1. 在 `tools/handlers/` 中创建新的处理器类
2. 继承 `BaseHandler` 类
3. 在 `ToolRegistry` 中注册新工具

## 🎨 设计优势

### 🧩 模块化
- 每个文件职责单一，易于理解
- 模块间依赖关系清晰
- 支持独立开发和测试

### 🔧 可维护性
- 修改单个功能只需修改对应模块
- 减少代码重复
- 统一的错误处理和日志

### 🚀 可扩展性
- 新工具只需创建新的处理器
- 基类提供通用功能
- 配置集中管理

### 🧪 可测试性
- 工具函数为纯函数，易于单元测试
- 处理器类依赖注入，易于 Mock
- 模块边界清晰，支持集成测试

## 📊 重构前后对比

| 指标 | 重构前 | 重构后 |
|------|--------|--------|
| 主文件行数 | 687 | ~80 |
| 文件数量 | 7 | 14 |
| 模块化程度 | 低 | 高 |
| 维护难度 | 高 | 低 |
| 扩展难度 | 高 | 低 |

## 🎉 总结

通过这次架构重构，我们将一个庞大的单文件应用转换为清晰的模块化架构：

- ✅ **代码更清晰**: 每个模块职责单一
- ✅ **维护更容易**: 修改影响范围小
- ✅ **扩展更简单**: 新功能只需添加新模块
- ✅ **测试更方便**: 模块独立，易于测试
- ✅ **协作更高效**: 多人可同时开发不同模块

这个新架构为项目的长期发展提供了坚实的基础！ 